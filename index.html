<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #059669;
      --secondary-dark: #047857;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--gray-100); color: var(--gray-800); font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: var(--shadow-xl); }
    .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; position: relative; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .header h1 { margin: 0 0 0.5rem; font-size: 2.25rem; font-weight: 700; }
    .header p { opacity: 0.9; font-size: 1.1rem; }
    .user-info { position: absolute; top: 1rem; right: 2rem; background: rgba(255, 255, 255, 0.15); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
    .nav-menu { background: var(--gray-800); display: flex; padding: 0 2rem; }
    .nav-item { padding: 1rem 1.5rem; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s ease; border-bottom: 3px solid transparent; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
    .nav-item.active { background: rgba(255, 255, 255, 0.05); border-bottom-color: var(--primary); }
    .content-section { padding: 2rem; display: none; }
    .content-section.active { display: block; }
    .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--gray-800); font-weight: 600; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; }
    .section-title .filter-badge { font-size: 0.9rem; font-weight: 500; background-color: var(--info); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; margin-left: 1rem; vertical-align: middle; }
    .upload-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .upload-box { background: var(--gray-100); border: 2px dashed var(--gray-300); border-radius: 0.75rem; padding: 1.5rem; transition: all 0.2s ease; position: relative; }
    .upload-box h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .upload-box.source2 { border-color: var(--secondary); background: rgba(5, 150, 105, 0.05); }
    .upload-box.source2::after { content: "(Paid Source)"; color: var(--secondary); font-size: 0.875rem; display: block; margin-top: 0.5rem; font-weight: 500; }
    .upload-box.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
    .file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; user-select: none; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:disabled { background: var(--gray-300); color: var(--gray-500); cursor: not-allowed; transform: none; box-shadow: none; }
    .file-info { margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(5, 150, 105, 0.1); color: var(--secondary-dark); border-radius: 0.5rem; font-size: 0.9375rem; font-weight: 500; display: none; }
    .file-info.show { display: inline-block; }
    .mapping-group { margin-bottom: 2rem; background: var(--gray-50); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow-sm); }
    .mapping-group h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .mapping-row { display: flex; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .mapping-row label { min-width: 180px; font-weight: 500; color: var(--gray-700); }
    select, input[type="number"], input[type="text"] { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; font-size: 0.9375rem; min-width: 220px; background: white; }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    .options-section, .commission-input { margin-bottom: 2rem; }
    .checkbox-group { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .checkbox-group input { margin-right: 0.75rem; }
    .checkbox-group label { font-weight: 500; color: var(--gray-700); }
    .gst-options { background: rgba(14, 165, 233, 0.05); border-left: 4px solid var(--info); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .gst-options h4 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.1rem; color: var(--gray-700); }
    .analyze-btn { width: 100%; padding: 1rem; margin: 2rem 0; font-size: 1.1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow); border-top: 4px solid var(--primary); }
    .stat-card.warning { border-top-color: var(--warning); }
    .stat-card.danger { border-top-color: var(--danger); }
    .stat-card.success { border-top-color: var(--secondary); }
    .stat-card.info { border-top-color: var(--info); }
    .stat-card h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; color: var(--gray-600); }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem; }
    .stat-subtext { font-size: 0.875rem; color: var(--gray-500); }
    .alert-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .alert-box { background: white; border-left: 5px solid var(--warning); border-radius: 0.75rem; box-shadow: var(--shadow); padding: 1.5rem; height: 100%; }
    .alert-box.empty { background: var(--gray-50); border-left-color: var(--gray-400); }
    .alert-box.danger { border-left-color: var(--danger); }
    .alert-box.success { border-left-color: var(--secondary); }
    .alert-box.info { border-left-color: var(--info); }
    .alert-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--warning); }
    .alert-box.empty .alert-title { color: var(--gray-500); }
    .alert-box.danger .alert-title { color: var(--danger); }
    .alert-box.success .alert-title { color: var(--secondary); }
    .alert-box.info .alert-title { color: var(--info); }
    .alert-count { font-size: 1.25rem; font-weight: 800; margin-bottom: 1rem; }
    .alert-table { width: 100%; border-collapse: collapse; font-size: 0.9375rem; margin-top: 1rem; }
    .alert-table th, .alert-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .alert-table th { background: var(--gray-50); color: var(--gray-700); font-weight: 600; }
    .alert-table tr:last-child td { border-bottom: none; }
    .amount-cell { text-align: right; font-family: 'Roboto Mono', monospace; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
    .loading-overlay.show { visibility: visible; opacity: 1; }
    .spinner { width: 3rem; height: 3rem; border: 4px solid rgba(99, 102, 241, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .error-message { margin: 1rem 0; padding: 1rem; background: rgba(220, 38, 38, 0.1); color: var(--danger); border-radius: 0.5rem; display: none; border-left: 4px solid var(--danger); }
    .error-message.show { display: block; }
    .export-btn { margin-top: 1rem; }
    .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.2s ease; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background-color: rgba(99, 102, 241, 0.05); }
    .tab:hover:not(.active) { color: var(--primary-dark); background-color: rgba(99, 102, 241, 0.05); }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .upload-section, .alert-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info">User: ksismad</div>
      <h1>üîç Advanced App ID Analyzer Pro (Care4Sign)</h1>
      <p>Comprehensive Payment Reconciliation & Analysis Tool</p>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" data-content="main-analysis">Main Analysis</a>
    </nav>

    <!-- Main Analysis Section -->
    <div id="main-analysis" class="content-section active">
      <h2 class="section-title">Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 Files (e.g., Platinum Partner All Details)</h3>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" id="upload-btn-1">Choose Files</button>
          <div id="file-info-1" class="file-info"></div>
        </div>
        <div class="upload-box source2" id="drop2">
          <h3>Source 2 File (Paid Source)</h3>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" id="upload-btn-2" style="background:var(--secondary);">Choose File</button>
          <div id="file-info-2" class="file-info"></div>
        </div>
      </div>
      
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Source 1)</h3>
        <div id="bp-code-filter"></div>
      </div>

      <div id="column-mappings-container">
        <h2 class="section-title">Column Mappings & Options</h2>
        <div class="mapping-group" id="column-mappings"></div>
        <div class="options-section">
            <div class="gst-options">
              <h4>GST Options (for S1 Basic Amount)</h4>
              <div class="checkbox-group">
                <input type="checkbox" id="apply-gst">
                <label for="apply-gst">Apply 18% GST to S1 'Basic Amount' for internal comparison</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="gst-round" disabled>
                <label for="gst-round">Round GST amounts to nearest whole number</label>
              </div>
            </div>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <button id="analyze-btn" class="btn btn-primary analyze-btn" disabled>Analyze Data</button>

      <div id="results-section" style="display: none;">
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
        </div>

        <div id="summary-view" class="tab-content active">
          <h2 class="section-title" id="summary-title">Analysis Summary</h2>
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>

        <div id="detailed-view" class="tab-content">
          <h2 class="section-title">Detailed Results</h2>
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary export-btn">Export Detailed Report</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay"> <div class="spinner"></div> </div>

  <script>
    const AppState = (() => {
      let state = {
        source1Files: [], source2Files: [], columnMappings: {}, selectedBPCode: 'all',
        analysisOptions: { applyGST: false, gstRound: false }, analysisResults: null,
      };
      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        if (source1Files.length === 0 || source2Files.length === 0) return false;
        const s1Required = ['appId', 'amount', 'date', 'bpCode', 'product', 'priceInclGST'];
        const s2Required = ['appId', 's2Amount'];
        const s1Valid = s1Required.every(id => columnMappings[id]?.source1);
        const s2Valid = s2Required.every(id => columnMappings[id]?.source2);
        return s1Valid && s2Valid;
      };
      return {
        getState: () => ({ ...state }),
        setState: (newState) => { state = { ...state, ...newState }; return validateState(); },
        resetAnalysis: () => { state.analysisResults = null; },
        isValid: validateState
      };
    })();

    const DOM = {
      fileInput1: document.getElementById('file-input-1'),
      uploadBtn1: document.getElementById('upload-btn-1'),
      fileInfo1: document.getElementById('file-info-1'),
      fileInput2: document.getElementById('file-input-2'),
      uploadBtn2: document.getElementById('upload-btn-2'),
      fileInfo2: document.getElementById('file-info-2'),
      bpCodeFilterContainer: document.getElementById('bp-code-filter-container'),
      bpCodeFilter: document.getElementById('bp-code-filter'),
      columnMappings: document.getElementById('column-mappings'),
      applyGST: document.getElementById('apply-gst'),
      gstRound: document.getElementById('gst-round'),
      analyzeBtn: document.getElementById('analyze-btn'),
      resultsSection: document.getElementById('results-section'),
      summaryTitle: document.getElementById('summary-title'),
      statsGrid: document.getElementById('stats-grid'),
      results: document.getElementById('results'),
      detailedResults: document.getElementById('detailed-results'),
      exportDetailedBtn: document.getElementById('export-detailed-btn'),
      loadingOverlay: document.getElementById('loading-overlay'),
      errorMessage: document.getElementById('error-message'),
      userInfo: document.getElementById('user-info'),
      navItems: document.querySelectorAll('.nav-item'),
      contentSections: document.querySelectorAll('.content-section'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
    };

    const Utils = {
      showLoading: () => DOM.loadingOverlay.classList.add('show'),
      hideLoading: () => DOM.loadingOverlay.classList.remove('show'),
      showError: (msg) => { console.error("Error:", msg); DOM.errorMessage.textContent = msg; DOM.errorMessage.style.display = 'block'; setTimeout(() => DOM.errorMessage.style.display = 'none', 8000); },
      updateUserInfo: () => { const now = new Date().toISOString().replace('T', ' ').slice(0, 19); DOM.userInfo.textContent = `User: ksismad | UTC ${now}`; },
      formatNumber: (num, dec = 2) => (typeof num !== 'number' || isNaN(num)) ? num : parseFloat(num.toFixed(dec)).toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec }),
      findMatch: (headers, patterns) => { if (!headers || !patterns) return ''; for (let p of patterns) { const i = headers.findIndex(h => h && p.test(String(h))); if (i !== -1) return i; } return ''; },
      safeParseFloat: (v) => { if (typeof v === 'number') return v; if (typeof v === 'string') { return parseFloat(v.replace(/[^0-9.-]/g, '')) || 0; } return 0; },
    };

    const UIManager = {
      resetAnalysisUI: () => {
        DOM.resultsSection.style.display = 'none';
        AppState.resetAnalysis();
        DOM.results.innerHTML = '';
        DOM.statsGrid.innerHTML = '';
        DOM.detailedResults.innerHTML = '';
        DOM.summaryTitle.innerHTML = 'Analysis Summary';
      }
    };

    const FileHandler = {
      init: () => {
        DOM.uploadBtn1.onclick = () => DOM.fileInput1.click();
        DOM.uploadBtn2.onclick = () => DOM.fileInput2.click();
        DOM.fileInput1.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 1); };
        DOM.fileInput2.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 2); };
        [DOM.applyGST, DOM.gstRound].forEach(el => el.onchange = FileHandler.handleOptionChange);
      },
      handleOptionChange: () => {
        const isGSTEnabled = DOM.applyGST.checked;
        DOM.gstRound.disabled = !isGSTEnabled;
        if (!isGSTEnabled) DOM.gstRound.checked = false;
        AppState.setState({ analysisOptions: { applyGST: isGSTEnabled, gstRound: DOM.gstRound.checked } });
        UIManager.resetAnalysisUI();
      },
      handleFileSelection: async (files, src) => {
        UIManager.resetAnalysisUI();
        Utils.showLoading();
        try {
          const file = files[0];
          const data = await FileHandler.processExcelFile(file);
          const fileInfo = { file, headers: data[0], records: data.slice(1), fileName: file.name };
          
          if (src === 1) {
            AppState.setState({ source1Files: [fileInfo] });
            DOM.fileInfo1.textContent = `${file.name} (${fileInfo.records.length} rows)`;
            DOM.fileInfo1.classList.add('show');
          } else {
            AppState.setState({ source2Files: [fileInfo] });
            DOM.fileInfo2.textContent = `${file.name} (${fileInfo.records.length} rows)`;
            DOM.fileInfo2.classList.add('show');
          }
          ColumnMapper.setup();
        } catch (error) { Utils.showError(error.message);
        } finally { Utils.hideLoading(); }
      },
      processExcelFile: (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!data || data.length < 2) return reject(new Error('File has no data rows.'));
            resolve(data.filter(row => row.some(cell => cell !== null && cell !== '')));
          } catch (err) { reject(new Error(`Error parsing file: ${err.message}`)); }
        };
        reader.onerror = () => reject(new Error('Error reading file.'));
        reader.readAsArrayBuffer(file);
      }),
    };

    const ColumnMapper = {
      setup: () => {
        const { source1Files, source2Files } = AppState.getState();
        const s1Headers = source1Files[0]?.headers || [];
        const s2Headers = source2Files[0]?.headers || [];
        
        if (s1Headers.length === 0 || s2Headers.length === 0) return;
        
        const columns = [
          { id: 'appId', s1Label: 'S1 App ID', s2Label: 'S2 App ID', s1Patterns: [/app.*id/i, /applicati/i], s2Patterns: [/app.*id/i, /applicati/i], required: true },
          { id: 'amount', s1Label: 'S1 Basic Amount', s1Patterns: [/basic/i], required: true },
          { id: 'priceInclGST', s1Label: 'S1 Price (incl. GST)', s1Patterns: [/price.*gst/i, /price i/i], required: true },
          { id: 's2Amount', s2Label: 'S2 Amount', s2Patterns: [/amount/i, /price/i], required: true },
          { id: 'bpCode', s1Label: 'S1 BP Code', s1Patterns: [/bp.*code/i], required: true },
          { id: 'product', s1Label: 'S1 Product', s1Patterns: [/product/i], required: true },
          { id: 'date', s1Label: 'S1 Date', s1Patterns: [/date/i, /added ti/i], required: true },
        ];
        
        let html = '';
        columns.forEach(col => {
          const s1Selected = col.s1Patterns ? Utils.findMatch(s1Headers, col.s1Patterns) : null;
          const s2Selected = col.s2Patterns ? Utils.findMatch(s2Headers, col.s2Patterns) : null;
          html += `<div class="mapping-row">`;
          if (col.s1Label) html += `<label for="ms1-${col.id}">${col.s1Label}${col.required ? ' *' : ''}</label><select id="ms1-${col.id}" data-col="${col.id}" data-src="1"><option value="">Select Column</option>${s1Headers.map((h, i) => `<option value="${i}" ${s1Selected === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
          if (col.s2Label) html += `<label for="ms2-${col.id}">${col.s2Label}${col.required ? ' *' : ''}</label><select id="ms2-${col.id}" data-col="${col.id}" data-src="2"><option value="">Select Column</option>${s2Headers.map((h, i) => `<option value="${i}" ${s2Selected === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
          html += '</div>';
        });
        
        DOM.columnMappings.innerHTML = html;
        document.querySelectorAll('select[data-col]').forEach(el => el.addEventListener('change', ColumnMapper.update));
        ColumnMapper.update();
        ColumnMapper.populateBPCodeFilter();
      },
      update: () => {
        UIManager.resetAnalysisUI();
        const mappings = {};
        document.querySelectorAll('select[data-col]').forEach(sel => {
            const id = sel.dataset.col;
            const src = sel.dataset.src === '1' ? 'source1' : 'source2';
            if (!mappings[id]) mappings[id] = {};
            mappings[id][src] = sel.value;
        });
        AppState.setState({ columnMappings: mappings });
        Analyzer.updateAnalyzeBtn();
      },
      populateBPCodeFilter: () => {
        const { source1Files, columnMappings } = AppState.getState();
        const bpCodeIndex = columnMappings.bpCode?.source1;
        if (!source1Files[0] || !bpCodeIndex) { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
        const uniqueBPCodes = [...new Set(source1Files[0].records.map(r => r[bpCodeIndex]).filter(Boolean))].sort();
        if (uniqueBPCodes.length === 0) { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
        DOM.bpCodeFilter.innerHTML = `<select id="bp-code-select" style="width: 100%;"><option value="all">All BP Codes</option>${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}</select>`;
        DOM.bpCodeFilterContainer.style.display = 'block';
        document.getElementById('bp-code-select').onchange = (e) => { AppState.setState({ selectedBPCode: e.target.value }); UIManager.resetAnalysisUI(); };
      }
    };

    const Analyzer = {
      updateAnalyzeBtn: () => {
        const isValid = AppState.isValid();
        DOM.analyzeBtn.disabled = !isValid;
        DOM.analyzeBtn.textContent = isValid ? 'Analyze Data' : 'Select Files & All Required Mappings (*)';
      },
      analyzeData: () => {
        try {
          const { source1Files, source2Files, columnMappings, selectedBPCode, analysisOptions } = AppState.getState();
          const s1File = source1Files[0], s2File = source2Files[0];
          
          let s1Records = s1File.records;
          if (selectedBPCode !== 'all') {
              const bpCodeIndex = columnMappings.bpCode.source1;
              s1Records = s1Records.filter(r => String(r[bpCodeIndex]) === String(selectedBPCode));
          }
          
          const idx = columnMappings;
          const commissionPatterns = [/platin/i, /bp co/i, /bp wis/i];
          const commissionIndices = s1File.headers.map((h, i) => commissionPatterns.some(p => p.test(h)) ? i : -1).filter(i => i !== -1);
          
          const scenarios = {
            "S1 GST Calculation Mismatch": [], "Price Exceeds Standard Rate": [],
            "S1 (incl. GST) vs S2 Amount Mismatch": [], "S1 Paid but missing in S2": [],
            "S2 Paid but missing in S1": [], "Duplicates in S1": [], "Duplicates in S2": [],
            // Placeholder cards from image
            "S2 Paid, S1 Unpaid": [], "Commission received higher than desired": [],
            "Commission received lower than desired": [], "S1 Marked Paid but Commission Missing": [],
            "S1 Marked Unpaid but Commission Exists": []
          };
          let totalS1Commission = 0;
          const standardRates = { 'CLASS_3_SIGNING_2_YEAR': 840.00, 'CLASS_3_SIGNING_E_NCRYPTION_2_YEAR': 1680.00 };
          const normalizeProductKey = (str) => (typeof str !== 'string') ? '' : str.toUpperCase().replace(/[^A-Z0-9]/g, '_').replace(/_+/g, '_');

          const s2Map = new Map(s2File.records.map(r => [String(r[idx.appId.source2]), r]));
          const s1AppIds = new Set();

          s1Records.forEach(r1 => {
              const appId = String(r1[idx.appId.source1]);
              if (!appId) return;

              if (s1AppIds.has(appId)) scenarios["Duplicates in S1"].push({ AppID: appId }); else s1AppIds.add(appId);

              const commissionAmount = commissionIndices.reduce((sum, i) => sum + Utils.safeParseFloat(r1[i]), 0);
              totalS1Commission += commissionAmount;
              
              const basicAmount = Utils.safeParseFloat(r1[idx.amount.source1]);
              const priceInclGST = Utils.safeParseFloat(r1[idx.priceInclGST.source1]);
              
              if (analysisOptions.applyGST) {
                  let calculatedGSTPrice = basicAmount * 1.18;
                  if (analysisOptions.gstRound) calculatedGSTPrice = Math.round(calculatedGSTPrice);
                  if (Math.abs(calculatedGSTPrice - priceInclGST) > 0.01) {
                      scenarios["S1 GST Calculation Mismatch"].push({ AppID: appId, Basic: basicAmount, Calculated: calculatedGSTPrice, Actual: priceInclGST, Diff: calculatedGSTPrice - priceInclGST });
                  }
              }

              const productKey = normalizeProductKey(r1[idx.product.source1]);
              const standardRate = standardRates[productKey];
              if (standardRate && basicAmount > standardRate) {
                  scenarios["Price Exceeds Standard Rate"].push({ AppID: appId, Product: r1[idx.product.source1], BasicAmount: basicAmount, StandardRate: standardRate, Diff: basicAmount - standardRate });
              }
              
              const r2 = s2Map.get(appId);
              if (r2) {
                  const s2Amount = Utils.safeParseFloat(r2[idx.s2Amount.source2]);
                  if (Math.abs(priceInclGST - s2Amount) > 0.01) {
                      scenarios["S1 (incl. GST) vs S2 Amount Mismatch"].push({ AppID: appId, S1_GST_Price: priceInclGST, S2_Amount: s2Amount, Diff: priceInclGST - s2Amount });
                  }
              } else {
                  scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_Amount: basicAmount, S1_GST_Price: priceInclGST });
              }
          });

          const s2AppIds = new Set(s2File.records.map(r => String(r[idx.appId.source2])));
          s2AppIds.forEach(appId => { if (appId && !s1AppIds.has(appId)) scenarios["S2 Paid but missing in S1"].push({ AppID: appId }); });
          scenarios["Duplicates in S2"] = _.chain(s2File.records).countBy(r => r[idx.appId.source2]).pickBy(c => c > 1).keys().map(id => ({ AppID: id })).value();
          
          AppState.setState({ analysisResults: { ...scenarios, totalS1Commission } });
          return AppState.getState().analysisResults;
        } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); console.error(error); return null; }
      },
      displayResults: (results) => {
        const { totalS1Commission } = results;
        const { selectedBPCode } = AppState.getState();
        if (selectedBPCode !== 'all') DOM.summaryTitle.innerHTML = `Analysis Summary <span class="filter-badge">Filtered by: ${selectedBPCode}</span>`;
        
        const orderedScenarios = [
            "S1 GST Calculation Mismatch", "Price Exceeds Standard Rate", "S1 (incl. GST) vs S2 Amount Mismatch",
            "S1 Paid but missing in S2", "S2 Paid but missing in S1", "S2 Paid, S1 Unpaid",
            "Duplicates in S1", "Duplicates in S2", "Commission received higher than desired",
            "Commission received lower than desired", "S1 Marked Paid but Commission Missing", "S1 Marked Unpaid but Commission Exists"
        ];
        
        DOM.statsGrid.innerHTML = `
          <div class="stat-card success"><h3>Total S1 Commission</h3><div class="stat-value">${Utils.formatNumber(totalS1Commission)}</div><div class="stat-subtext">Sum of all commission columns</div></div>
          <div class="stat-card danger"><h3>GST Mismatches</h3><div class="stat-value">${results["S1 GST Calculation Mismatch"].length}</div><div class="stat-subtext">Internal S1 calculation errors</div></div>
          <div class="stat-card warning"><h3>Price Over-runs</h3><div class="stat-value">${results["Price Exceeds Standard Rate"].length}</div><div class="stat-subtext">Basic price > standard rate</div></div>
          <div class="stat-card danger"><h3>S1 vs S2 Mismatches</h3><div class="stat-value">${results["S1 (incl. GST) vs S2 Amount Mismatch"].length}</div><div class="stat-subtext">Post-GST amount differences</div></div>
        `;
        
        let summaryHtml = '', detailedHtml = '';
        orderedScenarios.forEach(scenarioName => {
            const records = results[scenarioName] || [];
            let boxClass = 'alert-box';
            if (records.length === 0) boxClass += ' empty';
            else if (scenarioName.includes('Mismatch') || scenarioName.includes('missing in S2')) boxClass += ' danger';
            else if (scenarioName.includes('Over-run') || scenarioName.includes('Duplicates')) boxClass += ' warning';
            else boxClass += ' info';
            
            const cardHtml = (limit) => {
                let html = `<div class="${boxClass}"><div class="alert-title">${scenarioName}</div><div class="alert-count">${records.length} records</div>`;
                if (records.length > 0) {
                    const headers = Object.keys(records[0]);
                    html += `<div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>`;
                    const displayRecords = limit ? records.slice(0, limit) : records;
                    displayRecords.forEach(rec => {
                        html += `<tr>${headers.map(h => `<td class="${typeof rec[h] === 'number' ? 'amount-cell' : ''}">${Utils.formatNumber(rec[h])}</td>`).join('')}</tr>`;
                    });
                    html += `</tbody></table></div>`;
                    if (limit && records.length > limit) html += `<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);">+ ${records.length - limit} more</div>`;
                } else { html += `<div style="color:var(--gray-500);font-style:italic;margin-top:0.5rem;">No records found</div>`; }
                html += `</div>`;
                return html;
            }
            
            summaryHtml += cardHtml(5);
            if (records.length > 0) {
                detailedHtml += `<h3 style="margin-top:2rem;color:var(--gray-700);">${scenarioName} (${records.length} records)</h3>${cardHtml(null)}`;
            }
        });

        DOM.results.innerHTML = summaryHtml;
        DOM.detailedResults.innerHTML = detailedHtml || '<p>No detailed results to display.</p>';
        DOM.resultsSection.style.display = 'block';
        DOM.resultsSection.scrollIntoView({ behavior: 'smooth' });
      },
      exportDetailedResults: () => {
          const { analysisResults } = AppState.getState();
          if (!analysisResults) return Utils.showError("No analysis results to export.");
          const { totalS1Commission, ...scenarios } = analysisResults;
          const sheets = Object.entries(scenarios).map(([name, records]) => ({ name, records })).filter(s => s.records.length > 0);
          if (sheets.length === 0) return Utils.showError("No data to export.");
          
          Utils.showLoading();
          try {
            const wb = XLSX.utils.book_new();
            sheets.forEach(sheet => {
              const ws = XLSX.utils.json_to_sheet(sheet.records);
              XLSX.utils.book_append_sheet(wb, ws, sheet.name.substring(0, 31));
            });
            XLSX.writeFile(wb, `Care4Sign_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
          } catch (error) { Utils.showError(`Export failed: ${error.message}`); } 
          finally { Utils.hideLoading(); }
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      try {
        FileHandler.init();
        Utils.updateUserInfo();
        setInterval(Utils.updateUserInfo, 30000);
        
        DOM.analyzeBtn.addEventListener('click', () => {
          Utils.showLoading();
          setTimeout(() => {
            try {
              const results = Analyzer.analyzeData();
              if (results) Analyzer.displayResults(results);
            } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); }
            finally { Utils.hideLoading(); }
          }, 10);
        });
        
        DOM.exportDetailedBtn.addEventListener('click', Analyzer.exportDetailedResults);
        
        DOM.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            DOM.tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            DOM.tabContents.forEach(c => c.classList.toggle('active', c.id.startsWith(tabName)));
          });
        });
        
      } catch (error) { document.body.innerHTML = `<div style="padding:2rem;color:red;">App failed to initialize: ${error.message}</div>`; }
    });
  </script>
</body>
</html>
