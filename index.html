<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #059669;
      --secondary-dark: #047857;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--gray-100);
      color: var(--gray-800);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      box-shadow: var(--shadow-xl);
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 2rem;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      margin: 0 0 0.5rem;
      font-size: 2.25rem;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .user-info {
      position: absolute;
      top: 1rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.15);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .nav-menu {
      background: var(--gray-800);
      display: flex;
      padding: 0 2rem;
    }

    .nav-item {
      padding: 1rem 1.5rem;
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.05);
      border-bottom-color: var(--primary);
    }

    .content-section {
      padding: 2rem;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--gray-800);
      font-weight: 600;
      border-bottom: 2px solid var(--gray-200);
      padding-bottom: 0.5rem;
    }
    
    .section-title .filter-badge {
        font-size: 0.9rem;
        font-weight: 500;
        background-color: var(--info);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        margin-left: 1rem;
        vertical-align: middle;
    }

    .upload-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .upload-box {
      background: var(--gray-100);
      border: 2px dashed var(--gray-300);
      border-radius: 0.75rem;
      padding: 1.5rem;
      transition: all 0.2s ease;
      position: relative;
    }

    .upload-box h3 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--gray-700);
    }

    .upload-box.source2 {
      border-color: var(--secondary);
      background: rgba(5, 150, 105, 0.05);
    }

    .upload-box.source2::after {
      content: "(Paid Source)";
      color: var(--secondary);
      font-size: 0.875rem;
      display: block;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .upload-box.dragover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      user-select: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--secondary-dark), var(--secondary));
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      background: var(--gray-300);
      color: var(--gray-500);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .file-info {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(5, 150, 105, 0.1);
      color: var(--secondary-dark);
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      font-weight: 500;
      display: none;
    }

    .file-info.show {
      display: inline-block;
    }

    .file-list {
      margin-top: 1rem;
      padding-left: 0;
      list-style-type: none;
    }

    .file-list li {
      padding: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
      font-size: 0.9375rem;
      display: flex;
      justify-content: space-between;
    }

    .file-list li:last-child {
      border-bottom: none;
    }

    .merge-btn {
      margin-top: 1rem;
    }

    .mapping-group {
      margin-bottom: 2rem;
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-sm);
    }

    .mapping-group h3 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--gray-700);
    }

    .mapping-row {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .mapping-row.commission-row {
        align-items: flex-start;
    }
    .commission-checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.5rem 1rem;
        background: white;
        padding: 1rem;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        flex-grow: 1;
    }
    .commission-checkbox-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        min-width: auto;
    }
    .commission-checkbox-group input {
        margin-right: 0.5rem;
    }


    .mapping-row label {
      min-width: 180px;
      font-weight: 500;
      color: var(--gray-700);
    }

    select, input[type="number"], input[type="text"] {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      min-width: 220px;
      background: white;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .analyze-btn {
      width: 100%;
      padding: 1rem;
      margin: 2rem 0;
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      border-top: 4px solid var(--primary);
    }

    .stat-card.warning { border-top-color: var(--warning); }
    .stat-card.danger { border-top-color: var(--danger); }
    .stat-card.success { border-top-color: var(--secondary); }
    .stat-card.info { border-top-color: var(--info); }

    .stat-card h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-600);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .stat-subtext {
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .alert-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .alert-box {
      background: white;
      border-left: 5px solid var(--warning);
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      height: 100%;
    }
    .alert-box.empty { background: var(--gray-50); border-left-color: var(--gray-400); }
    .alert-box.danger { border-left-color: var(--danger); }
    .alert-box.success { border-left-color: var(--secondary); }
    .alert-box.info { border-left-color: var(--info); }

    .alert-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--warning);
    }
    .alert-box.empty .alert-title { color: var(--gray-500); }
    .alert-box.danger .alert-title { color: var(--danger); }
    .alert-box.success .alert-title { color: var(--secondary); }
    .alert-box.info .alert-title { color: var(--info); }

    .alert-count {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--warning-dark);
      margin-bottom: 1rem;
    }
    .alert-box.empty .alert-count { color: var(--gray-500); }
    .alert-box.danger .alert-count { color: var(--danger); }
    .alert-box.success .alert-count { color: var(--secondary); }
    .alert-box.info .alert-count { color: var(--info); }

    .alert-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9375rem;
      margin-top: 1rem;
    }

    .alert-table th, .alert-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .alert-table th {
      background: var(--gray-50);
      color: var(--gray-700);
      font-weight: 600;
    }

    .alert-table tr:last-child td {
      border-bottom: none;
    }

    .amount-cell { text-align: right; font-family: 'Roboto Mono', monospace; }
    .amount-cell.positive { color: var(--secondary); }
    .amount-cell.negative { color: var(--danger); }

    .paid-cell { color: var(--secondary); font-weight: 600; }
    .unpaid-cell { color: var(--danger); font-weight: 600; }

    .loading-overlay {
      position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
    }
    .loading-overlay.show { visibility: visible; opacity: 1; }

    .spinner {
      width: 3rem; height: 3rem; border: 4px solid rgba(99, 102, 241, 0.1);
      border-top: 4px solid var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .error-message {
      margin: 1rem 0; padding: 1rem; background: rgba(220, 38, 38, 0.1);
      color: var(--danger); border-radius: 0.5rem; display: none;
      border-left: 4px solid var(--danger);
    }
    .error-message.show { display: block; }
    
    .export-btn { margin-top: 1rem; }
    .manual-compare-textarea {
      width: 100%; min-height: 200px; padding: 0.75rem;
      border: 1px solid var(--gray-300); border-radius: 0.5rem;
      font-family: 'Roboto Mono', monospace; font-size: 0.875rem;
    }
    
    /* Other static styles from original */
    .success-message { margin: 1rem 0; padding: 1rem; background: rgba(5, 150, 105, 0.1); color: var(--secondary-dark); border-radius: 0.5rem; display: none; border-left: 4px solid var(--secondary); }
    .success-message.show { display: block; }
    .manual-compare-section { margin-top: 2rem; }
    .manual-compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .manual-compare-box { background: var(--gray-50); border-radius: 0.75rem; padding: 1.5rem; box-shadow: var(--shadow-sm); }
    .manual-compare-box h3 { margin-top: 0; margin-bottom: 1rem; color: var(--gray-700); }
    .manual-compare-btn { margin-top: 1rem; width: 100%; }
    .manual-compare-results { margin-top: 2rem; background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: var(--shadow-sm); }
    .manual-compare-results h3 { margin-top: 0; margin-bottom: 1rem; color: var(--gray-700); }
    .result-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .result-table th, .result-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .result-table th { background: var(--gray-50); color: var(--gray-700); font-weight: 600; }
    .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.2s ease; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background-color: rgba(99, 102, 241, 0.05); }
    .tab:hover:not(.active) { color: var(--primary-dark); background-color: rgba(99, 102, 241, 0.05); }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header, .content-section { padding: 1.5rem; }
      .upload-section, .alert-container, .manual-compare-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info">User: ksismad | UTC 2025-06-20 20:51:09</div>
      <h1>üîç Advanced App ID Analyzer Pro (Care4Sign)</h1>
      <p>Comprehensive Payment Reconciliation & Analysis Tool</p>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" data-content="main-analysis">Main Analysis</a>
      <a href="#" class="nav-item" data-content="manual-comparison">Manual Comparison</a>
    </nav>

    <!-- Main Analysis Section -->
    <div id="main-analysis" class="content-section active">
      <h2 class="section-title">Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 Files</h3>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" id="upload-btn-1">Choose Files</button>
          <div id="file-info-1" class="file-info"></div>
          <ul id="file-list-1" class="file-list"></ul>
          <button id="merge-btn-1" class="btn btn-info merge-btn" style="display:none;">Merge S1 Files</button>
        </div>
        <div class="upload-box source2" id="drop2">
          <h3>Source 2 File (Always Paid)</h3>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
          <button class="btn btn-secondary" id="upload-btn-2">Choose File</button>
          <div id="file-info-2" class="file-info"></div>
        </div>
      </div>
      
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Source 1)</h3>
        <div id="bp-code-filter">
          <p>Load a Source 1 file and map the 'BP Code' column to enable this filter.</p>
        </div>
      </div>

      <div id="column-mappings">
        <h2 class="section-title">Column Mappings</h2>
        <div class="mapping-group">
          <div id="mapping-fields"></div>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <div id="success-message" class="success-message"></div>
      <button id="analyze-btn" class="btn btn-secondary analyze-btn" disabled>Analyze Data</button>

      <div id="results-section" style="display: none;">
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
        </div>

        <div id="summary-view" class="tab-content active">
          <h2 class="section-title" id="summary-title">Analysis Summary</h2>
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>

        <div id="detailed-view" class="tab-content">
          <h2 class="section-title">Detailed Results</h2>
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary export-btn">Export Detailed Report</button>
        </div>
      </div>
    </div>

    <!-- Manual Comparison Section -->
    <div id="manual-comparison" class="content-section">
        <!-- Manual comparison content is unchanged -->
        <h2 class="section-title">App ID Comparison</h2>
        <p>Enter App IDs to compare between Source 1 and Source 2</p>
        <div class="manual-compare-grid">
            <div class="manual-compare-box">
            <h3>Source 1 App IDs</h3>
            <textarea id="manual-s1-data" class="manual-compare-textarea" placeholder="Enter App IDs (one per line or comma separated)
Example:
APP123
APP456
APP789"></textarea>
            <button id="compare-manual-btn" class="btn btn-primary manual-compare-btn">Compare App IDs</button>
            </div>
            
            <div class="manual-compare-box">
            <h3>Source 2 App IDs</h3>
            <textarea id="manual-s2-data" class="manual-compare-textarea" placeholder="Enter App IDs (one per line or comma separated)
Example:
APP123
APP456
APP789"></textarea>
            </div>
        </div>
        <div class="manual-compare-results">
            <h3>Comparison Results</h3>
            <div id="manual-results-container">
            <p>Enter App IDs in both boxes and click "Compare App IDs" to see results</p>
            </div>
        </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    const AppState = (() => {
      let state = {
        source1Files: [],
        source2Files: [],
        columnMappings: { commission: { source1: [] } }, // Init commission as array
        selectedBPCode: 'all',
        analysisResults: null,
      };

      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        if (source1Files.length === 0 || source2Files.length === 0) return false;

        const s1Required = ['appId', 'amount', 'date', 'bpCode', 'product'];
        const s2Required = ['appId', 's2Amount'];

        const s1Valid = s1Required.every(id => columnMappings[id]?.source1);
        const s2Valid = s2Required.every(id => columnMappings[id]?.source2);
        
        // At least one commission column must be selected
        const commissionValid = columnMappings.commission?.source1?.length > 0;

        return s1Valid && s2Valid && commissionValid;
      };

      return {
        getState: () => ({ ...state }),
        setState: (newState) => { 
          state = { ...state, ...newState }; 
          return validateState();
        },
        resetAnalysis: () => { state.analysisResults = null; },
        isValid: validateState
      };
    })();

    // DOM References
    const DOM = {
      // Main Analysis
      fileInput1: document.getElementById('file-input-1'),
      fileInput2: document.getElementById('file-input-2'),
      uploadBtn1: document.getElementById('upload-btn-1'),
      uploadBtn2: document.getElementById('upload-btn-2'),
      drop1: document.getElementById('drop1'),
      drop2: document.getElementById('drop2'),
      fileInfo1: document.getElementById('file-info-1'),
      fileInfo2: document.getElementById('file-info-2'),
      fileList1: document.getElementById('file-list-1'),
      mergeBtn1: document.getElementById('merge-btn-1'),
      mappingFields: document.getElementById('mapping-fields'),
      analyzeBtn: document.getElementById('analyze-btn'),
      resultsSection: document.getElementById('results-section'),
      results: document.getElementById('results'),
      statsGrid: document.getElementById('stats-grid'),
      loadingOverlay: document.getElementById('loading-overlay'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      userInfo: document.getElementById('user-info'),
      exportDetailedBtn: document.getElementById('export-detailed-btn'),
      detailedResults: document.getElementById('detailed-results'),
      bpCodeFilterContainer: document.getElementById('bp-code-filter-container'),
      bpCodeFilter: document.getElementById('bp-code-filter'),
      summaryTitle: document.getElementById('summary-title'),
      
      // Manual Comparison
      manualS1Data: document.getElementById('manual-s1-data'),
      manualS2Data: document.getElementById('manual-s2-data'),
      compareManualBtn: document.getElementById('compare-manual-btn'),
      manualResultsContainer: document.getElementById('manual-results-container'),
      
      // Navigation
      navItems: document.querySelectorAll('.nav-item'),
      contentSections: document.querySelectorAll('.content-section'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    const UIManager = {
      resetAnalysisUI: () => {
        DOM.resultsSection.style.display = 'none';
        AppState.resetAnalysis();
        DOM.results.innerHTML = '';
        DOM.statsGrid.innerHTML = '';
        DOM.detailedResults.innerHTML = '';
        DOM.summaryTitle.innerHTML = 'Analysis Summary';
      }
    };

    const Utils = {
      showLoading: () => DOM.loadingOverlay.classList.add('show'),
      hideLoading: () => DOM.loadingOverlay.classList.remove('show'),
      showError: (msg) => { console.error("Error:", msg); DOM.errorMessage.textContent = msg; DOM.errorMessage.classList.add('show'); setTimeout(() => DOM.errorMessage.classList.remove('show'), 8000); },
      showSuccess: (msg) => { DOM.successMessage.textContent = msg; DOM.successMessage.classList.add('show'); setTimeout(() => DOM.successMessage.classList.remove('show'), 5000); },
      updateUserInfo: () => { const now = new Date().toISOString().replace('T', ' ').slice(0, 19); DOM.userInfo.textContent = `User: ksismad | UTC ${now}`; },
      formatNumberForDisplay: (num, decimals = 2) => (typeof num !== 'number' || isNaN(num)) ? num : parseFloat(num.toFixed(decimals)).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }),
      findMatch: (headers, patterns) => {
        if (!headers || !patterns) return '';
        for (let pattern of patterns) {
          const index = headers.findIndex(h => h && pattern.test(String(h)));
          if (index !== -1) return index;
        }
        return '';
      },
      safeParseFloat: (value) => {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          const cleaned = value.replace(/[^0-9.-]/g, '');
          return parseFloat(cleaned) || 0;
        }
        return 0;
      },
      parseAppIds: (text) => text.split(/[\n,]/).map(id => id.trim()).filter(id => id.length > 0),
    };

    const FileHandler = {
      init: () => {
        DOM.uploadBtn1.onclick = e => { e.preventDefault(); DOM.fileInput1.value = ''; DOM.fileInput1.click(); };
        DOM.uploadBtn2.onclick = e => { e.preventDefault(); DOM.fileInput2.value = ''; DOM.fileInput2.click(); };
        DOM.fileInput1.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 1); };
        DOM.fileInput2.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 2); };
        [{ drop: DOM.drop1, src: 1 }, { drop: DOM.drop2, src: 2 }].forEach(o => {
          o.drop.ondragover = e => { e.preventDefault(); e.stopPropagation(); o.drop.classList.add('dragover'); };
          o.drop.ondragleave = e => { e.preventDefault(); e.stopPropagation(); o.drop.classList.remove('dragover'); };
          o.drop.ondrop = e => { e.preventDefault(); e.stopPropagation(); o.drop.classList.remove('dragover'); if (e.dataTransfer.files.length) FileHandler.handleFileSelection(e.dataTransfer.files, o.src); };
        });
      },
      handleFileSelection: async (files, src) => {
        UIManager.resetAnalysisUI();
        if (!files || files.length === 0) return Utils.showError('No files selected'); 
        if (src === 2 && files.length > 1) return Utils.showError('Source 2 can only accept one file.');
        
        Utils.showLoading();
        try {
          const fileArray = Array.from(files);
          const targetState = src === 1 ? 'source1Files' : 'source2Files';
          const fileListDOM = src === 1 ? DOM.fileList1 : null;
          const fileInfoDOM = src === 1 ? DOM.fileInfo1 : DOM.fileInfo2;
          
          AppState.setState({ [targetState]: [] });
          if (fileListDOM) fileListDOM.innerHTML = '';
          
          const results = await Promise.all(fileArray.map(file => FileHandler.processExcelFile(file).then(data => ({ file, data })).catch(err => ({ file, error: err }))));
          const successfulFiles = results.filter(r => !r.error).map(r => ({
            file: r.file, headers: r.data[0], records: r.data.slice(1), fileName: r.file.name
          }));
          
          if (successfulFiles.length > 0) {
            AppState.setState({ [targetState]: successfulFiles });
            if (fileListDOM) { successfulFiles.forEach(f => { const li = document.createElement('li'); li.innerHTML = `<span>${f.fileName}</span><span>${f.records.length} rows</span>`; fileListDOM.appendChild(li); }); }
            fileInfoDOM.textContent = `${successfulFiles.length} file(s) loaded`;
            fileInfoDOM.classList.add('show');
            if (src === 1) ColumnMapper.populateBPCodeFilter();
          }
          
          ColumnMapper.setupColumnMappings();
          
        } catch (error) { Utils.showError(`Unexpected error: ${error.message}`);
        } finally { Utils.hideLoading(); }
      },
      processExcelFile: (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!data || data.length < 2) return reject(new Error('File has no data rows.'));
            const cleanedData = data.filter(row => row.some(cell => cell !== null && cell !== '')).map(row => row.map(cell => typeof cell === 'string' ? cell.trim() : cell));
            if (cleanedData.length < 2) return reject(new Error('File has no valid data rows.'));
            resolve(cleanedData);
          } catch (err) { reject(new Error(`Error parsing file: ${err.message}`)); }
        };
        reader.onerror = () => reject(new Error('Error reading file.'));
        reader.readAsArrayBuffer(file);
      }),
    };

    const ColumnMapper = {
      setupColumnMappings: () => {
        const { source1Files, source2Files } = AppState.getState();
        const s1Headers = source1Files[0]?.headers || [];
        const s2Headers = source2Files[0]?.headers || [];
        
        if (s1Headers.length === 0 || s2Headers.length === 0) {
          DOM.mappingFields.innerHTML = '<p>Please load files for both sources to configure mappings.</p>';
          return;
        }
        
        const columns = [
          { id: 'appId', label: 'App ID (Application...)', patterns: [/app.*id/i, /applicati/i], required: true, s1: true, s2: true },
          { id: 'amount', label: 'Basic Amount (S1)', patterns: [/basic/i], required: true, s1: true },
          { id: 's2Amount', label: 'Amount (S2)', patterns: [/amount/i, /price/i], required: true, s2: true },
          { id: 'bpCode', label: 'BP Code (S1)', patterns: [/bp.*code/i], required: true, s1: true },
          { id: 'product', label: 'Product Description (S1)', patterns: [/product/i], required: true, s1: true },
          { id: 'commission', label: 'Commission Columns (S1)', patterns: [/commiss/i, /bp co/i, /platin/i], required: true, s1: true },
          { id: 'date', label: 'Date (S1)', patterns: [/date/i, /added ti/i], required: true, s1: true },
        ];
        
        let html = '';
        columns.forEach(col => {
          const s1Selected = col.s1 ? Utils.findMatch(s1Headers, col.patterns) : null;
          const s2Selected = col.s2 ? Utils.findMatch(s2Headers, col.patterns) : null;
          
          html += `<div class="mapping-row ${col.id === 'commission' ? 'commission-row' : ''}"><label>${col.label}${col.required ? ' *' : ''}:</label>`;
          
          if (col.id === 'commission') {
            html += `<div class="commission-checkbox-group">${s1Headers.map((h, i) => `
                <label><input type="checkbox" class="commission-checkbox" value="${i}">${h || `Column ${i+1}`}</label>
            `).join('')}</div>`;
          } else {
            if (col.s1) html += `<select id="ms1-${col.id}" data-col="${col.id}" data-src="1"><option value="">Select S1 Column</option>${s1Headers.map((h, i) => `<option value="${i}" ${s1Selected === i ? 'selected' : ''}>${h || `Column ${i+1}`}</option>`).join('')}</select>`;
            if (col.s2) html += `<select id="ms2-${col.id}" data-col="${col.id}" data-src="2"><option value="">Select S2 Column</option>${s2Headers.map((h, i) => `<option value="${i}" ${s2Selected === i ? 'selected' : ''}>${h || `Column ${i+1}`}</option>`).join('')}</select>`;
          }
          html += '</div>';
        });
        
        DOM.mappingFields.innerHTML = html;
        document.querySelectorAll('select, .commission-checkbox').forEach(el => el.addEventListener('change', ColumnMapper.updateColumnMappings));
        ColumnMapper.updateColumnMappings();
      },
      updateColumnMappings: () => {
        UIManager.resetAnalysisUI();
        const mappings = AppState.getState().columnMappings || { commission: { source1: [] } };
        
        document.querySelectorAll('select[data-col]').forEach(sel => {
            const id = sel.dataset.col;
            const src = sel.dataset.src === '1' ? 'source1' : 'source2';
            if (!mappings[id]) mappings[id] = {};
            mappings[id][src] = sel.value;
        });

        const commissionIndices = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);
        mappings.commission = { source1: commissionIndices };

        AppState.setState({ columnMappings: mappings });
        Analyzer.updateAnalyzeBtn();
      },
      populateBPCodeFilter: () => {
        const { source1Files, columnMappings } = AppState.getState();
        const bpCodeIndex = columnMappings.bpCode?.source1;

        if (source1Files.length === 0 || !bpCodeIndex) {
            DOM.bpCodeFilterContainer.style.display = 'none';
            return;
        }
        const uniqueBPCodes = [...new Set(source1Files.flatMap(f => f.records).map(r => r[bpCodeIndex]).filter(Boolean))].sort();
        if (uniqueBPCodes.length === 0) {
            DOM.bpCodeFilterContainer.style.display = 'none';
            return;
        }

        DOM.bpCodeFilter.innerHTML = `<select id="bp-code-select" style="width: 100%;"><option value="all">All BP Codes</option>${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}</select>`;
        DOM.bpCodeFilterContainer.style.display = 'block';
        document.getElementById('bp-code-select').addEventListener('change', (e) => {
            AppState.setState({ selectedBPCode: e.target.value });
            UIManager.resetAnalysisUI();
        });
      }
    };

    const Analyzer = {
      updateAnalyzeBtn: () => {
        const isValid = AppState.isValid();
        DOM.analyzeBtn.disabled = !isValid;
        DOM.analyzeBtn.textContent = isValid ? 'Analyze Data' : 'Select Files & Required Mappings';
      },
      analyzeData: () => {
        try {
          const { source1Files, source2Files, columnMappings, selectedBPCode } = AppState.getState();
          const s2 = source2Files[0];
          
          const standardRates = { 'CLASS_3_SIGNING_2_YEAR': 840.00, 'CLASS_3_SIGNING_E_NCRYPTION_2_YEAR': 1680.00, /* Add more from user prompt */ };
          const normalizeProductKey = (str) => (typeof str !== 'string') ? '' : str.toUpperCase().replace(/[^A-Z0-9]/g, '_').replace(/_+/g, '_');
          
          let combinedS1Records = source1Files.flatMap(file => file.records.map(record => ({ ...record, sourceFile: file.fileName })));
          
          if (selectedBPCode && selectedBPCode !== 'all') {
              const bpCodeIndex = columnMappings.bpCode.source1;
              combinedS1Records = combinedS1Records.filter(r => String(r[bpCodeIndex]) === String(selectedBPCode));
          }
          
          const idx = _.mapValues(columnMappings, (val) => val);

          const scenarios = { "Price Exceeds Standard Rate": [], "S1 Paid but missing in S2": [], "S2 Paid but missing in S1": [], "S2 Paid, S1 Paid but amount different": [], "Duplicates in S1": [] };
          let totalS1Commission = 0;
          
          const s2Map = new Map(s2.records.map(r => [String(r[idx.appId.source2]), r]));
          const s1Map = new Map();
          combinedS1Records.forEach(r => { const appId = String(r[idx.appId.source1]); if (appId) { if (!s1Map.has(appId)) s1Map.set(appId, []); s1Map.get(appId).push(r); } });

          s1Map.forEach((records, appId) => {
            records.forEach(r1 => {
              const commissionAmount = idx.commission.source1.reduce((sum, colIndex) => sum + Utils.safeParseFloat(r1[colIndex]), 0);
              const amount1Raw = Utils.safeParseFloat(r1[idx.amount.source1]);
              const productDesc = r1[idx.product.source1];
              const productKey = normalizeProductKey(productDesc);
              const standardRate = standardRates[productKey];

              totalS1Commission += commissionAmount;

              if (standardRate !== undefined && amount1Raw > standardRate) {
                  scenarios["Price Exceeds Standard Rate"].push({ AppID: appId, Product: productDesc, BasicAmount: amount1Raw, StandardRate: standardRate, Difference: amount1Raw - standardRate, BP_Code: r1[idx.bpCode.source1] });
              }

              const r2 = s2Map.get(appId);
              if (r2) {
                const amount2 = Utils.safeParseFloat(r2[idx.s2Amount.source2]);
                if (Math.abs(amount2 - amount1Raw) > 0.01) scenarios["S2 Paid, S1 Paid but amount different"].push({ AppID: appId, S1_Amount: amount1Raw, S2_Amount: amount2, Difference: amount2 - amount1Raw });
              } else {
                scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_Amount: amount1Raw, Date: r1[idx.date.source1] });
              }
            });
          });

          s2Map.forEach((r2, appId) => { if (!s1Map.has(appId)) { scenarios["S2 Paid but missing in S1"].push({ AppID: appId, S2_Amount: Utils.safeParseFloat(r2[idx.s2Amount.source2]) }); } });
          const s1Counts = _.countBy(combinedS1Records, r => String(r[idx.appId.source1]));
          for (const [id, count] of Object.entries(s1Counts)) { if (count > 1) scenarios['Duplicates in S1'].push({ AppID: id, Count: count }); }
          
          AppState.setState({ analysisResults: { ...scenarios, totalS1Commission } });
          return { ...scenarios, totalS1Commission };

        } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); console.error(error); return {}; }
      },
      displayResults: (results) => {
        const { totalS1Commission } = results;
        const { selectedBPCode } = AppState.getState();
        if (selectedBPCode && selectedBPCode !== 'all') {
            DOM.summaryTitle.innerHTML = `Analysis Summary <span class="filter-badge">Filtered by: ${selectedBPCode}</span>`;
        } else {
            DOM.summaryTitle.innerHTML = `Analysis Summary`;
        }

        const orderedScenarios = [ "Price Exceeds Standard Rate", "S1 Paid but missing in S2", "S2 Paid but missing in S1", "S2 Paid, S1 Paid but amount different", "Duplicates in S1" ];
        let totalAlerts = orderedScenarios.reduce((sum, s) => sum + (results[s]?.length || 0), 0);
        
        DOM.statsGrid.innerHTML = `
          <div class="stat-card danger"><h3>Total Alerts</h3><div class="stat-value">${totalAlerts}</div><div class="stat-subtext">Potential issues found</div></div>
          <div class="stat-card warning"><h3>Price Over-runs</h3><div class="stat-value">${results["Price Exceeds Standard Rate"]?.length || 0}</div><div class="stat-subtext">Basic price > standard rate</div></div>
          <div class="stat-card success"><h3>Total S1 Commission</h3><div class="stat-value">${Utils.formatNumberForDisplay(totalS1Commission)}</div><div class="stat-subtext">Sum of mapped commission</div></div>
          <div class="stat-card info"><h3>S1 Records Missing in S2</h3><div class="stat-value">${results["S1 Paid but missing in S2"]?.length || 0}</div><div class="stat-subtext">Records in S1 only</div></div>
        `;
        
        let summaryHtml = '', detailedHtml = '';
        orderedScenarios.forEach(scenarioName => {
            const records = results[scenarioName] || [];
            const isEmpty = records.length === 0;
            const boxClass = 'alert-box' + (isEmpty ? ' empty' : (scenarioName.includes('missing in S2') || scenarioName.includes('Price Exceeds') ? ' danger' : (scenarioName.includes('missing in S1') || scenarioName.includes('Duplicates') ? ' warning' : ' info')));
            
            summaryHtml += `<div class="${boxClass}"><div class="alert-title">${scenarioName}</div><div class="alert-count">${records.length} records</div>`;
            if (!isEmpty) {
                const headers = Object.keys(records[0]);
                summaryHtml += `<table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>`;
                records.slice(0, 5).forEach(rec => {
                    summaryHtml += `<tr>${headers.map(h => `<td>${typeof rec[h] === 'number' ? Utils.formatNumberForDisplay(rec[h]) : (rec[h] || 'N/A')}</td>`).join('')}</tr>`;
                });
                summaryHtml += `</tbody></table>`;
                if (records.length > 5) summaryHtml += `<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);">+ ${records.length - 5} more</div>`;
            } else { summaryHtml += `<div style="color:var(--gray-500);font-style:italic;margin-top:0.5rem;">No records found</div>`; }
            summaryHtml += `</div>`;

            if(!isEmpty) {
                const headers = Object.keys(records[0]);
                detailedHtml += `<h3 style="margin-top:2rem;color:var(--gray-700);">${scenarioName} (${records.length} records)</h3><div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>`;
                records.forEach(rec => { detailedHtml += `<tr>${headers.map(h => `<td>${typeof rec[h] === 'number' ? Utils.formatNumberForDisplay(rec[h]) : (rec[h] || 'N/A')}</td>`).join('')}</tr>`; });
                detailedHtml += `</tbody></table></div>`;
            }
        });

        DOM.results.innerHTML = summaryHtml;
        DOM.detailedResults.innerHTML = detailedHtml || '<p>No detailed results to display.</p>';
        DOM.resultsSection.style.display = 'block';
        DOM.resultsSection.scrollIntoView({ behavior: 'smooth' });
        Utils.showSuccess("Analysis completed successfully.");
      },
      exportDetailedResults: () => {
          const { analysisResults } = AppState.getState();
          if (!analysisResults) return Utils.showError("No analysis results to export.");
          const { totalS1Commission, ...scenarios } = analysisResults;
          const sheets = Object.entries(scenarios).map(([name, records]) => ({ name, records })).filter(s => s.records.length > 0);
          if (sheets.length === 0) return Utils.showError("No data to export.");
          
          Utils.showLoading();
          try {
            const wb = XLSX.utils.book_new();
            sheets.forEach(sheet => {
              const ws = XLSX.utils.json_to_sheet(sheet.records);
              XLSX.utils.book_append_sheet(wb, ws, sheet.name.substring(0, 31));
            });
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            XLSX.writeFile(wb, `Care4Sign_Detailed_Report_${timestamp}.xlsx`);
            Utils.showSuccess(`Report exported successfully.`);
          } catch (error) { Utils.showError(`Export failed: ${error.message}`); } 
          finally { Utils.hideLoading(); }
      }
    };

    const ManualComparison = { // Unchanged from original
        compareAppIds: () => {
            const s1 = Utils.parseAppIds(DOM.manualS1Data.value), s2 = Utils.parseAppIds(DOM.manualS2Data.value);
            if (s1.length === 0 && s2.length === 0) return Utils.showError("Please enter App IDs.");
            const s1Set = new Set(s1), s2Set = new Set(s2);
            const results = {
                "Only in Source 1": s1.filter(id => !s2Set.has(id)),
                "Only in Source 2": s2.filter(id => !s1Set.has(id)),
                "Common App IDs": s1.filter(id => s2Set.has(id))
            };
            let html = '';
            for(const [scenario, ids] of Object.entries(results)) {
                html += `<div class="alert-box info"><div class="alert-title">${scenario} (${new Set(ids).size})</div>`;
                if(ids.length > 0) html += `<textarea readonly class="manual-compare-textarea" style="min-height:100px;">${[...new Set(ids)].join('\n')}</textarea>`;
                html += `</div>`;
            }
            DOM.manualResultsContainer.innerHTML = `<div class="alert-container">${html}</div>`;
        }
    };
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      try {
        FileHandler.init();
        Utils.updateUserInfo();
        setInterval(Utils.updateUserInfo, 15000);
        
        DOM.analyzeBtn.addEventListener('click', () => {
          Utils.showLoading();
          setTimeout(() => { // Allow loading screen to render
            try {
              const results = Analyzer.analyzeData();
              if (results) Analyzer.displayResults(results);
            } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); console.error(error); }
            finally { Utils.hideLoading(); }
          }, 10);
        });
        
        DOM.exportDetailedBtn.addEventListener('click', Analyzer.exportDetailedResults);
        DOM.compareManualBtn.addEventListener('click', ManualComparison.compareAppIds);
        
        DOM.navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const contentId = item.dataset.content;
            DOM.navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            DOM.contentSections.forEach(sec => sec.classList.toggle('active', sec.id === contentId));
          });
        });
        
        DOM.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            const parent = tab.closest('.content-section');
            parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            parent.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id.startsWith(tabName)));
          });
        });
        
        console.log("Advanced App ID Analyzer Pro (Care4Sign) Initialized");
      } catch (error) {
        console.error("Initialization error:", error);
        document.body.innerHTML = `<div style="padding: 2rem; color: #dc2626; font-size: 1.2rem;">Application failed to initialize. Please check the console. Error: ${error.message}</div>`;
      }
    });
  </script>
</body>
</html>
