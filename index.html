<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #059669;
      --secondary-dark: #047857;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--gray-100);
      color: var(--gray-800);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      box-shadow: var(--shadow-xl);
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 2rem;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      margin: 0 0 0.5rem;
      font-size: 2.25rem;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .user-info {
      position: absolute;
      top: 1rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.15);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .nav-menu {
      background: var(--gray-800);
      display: flex;
      padding: 0 2rem;
    }

    .nav-item {
      padding: 1rem 1.5rem;
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.05);
      border-bottom-color: var(--primary);
    }

    .content-section {
      padding: 2rem;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--gray-800);
      font-weight: 600;
      border-bottom: 2px solid var(--gray-200);
      padding-bottom: 0.5rem;
    }

    .upload-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .upload-box {
      background: var(--gray-100);
      border: 2px dashed var(--gray-300);
      border-radius: 0.75rem;
      padding: 1.5rem;
      transition: all 0.2s ease;
      position: relative;
    }

    .upload-box h3 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--gray-700);
    }

    .upload-box.source2 {
      border-color: var(--secondary);
      background: rgba(5, 150, 105, 0.05);
    }

    .upload-box.source2::after {
      content: "(Paid Source)";
      color: var(--secondary);
      font-size: 0.875rem;
      display: block;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .upload-box.dragover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      user-select: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      color: white;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--secondary-dark), var(--secondary));
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-info:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      background: var(--gray-300);
      color: var(--gray-500);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .file-info {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(5, 150, 105, 0.1);
      color: var(--secondary-dark);
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      font-weight: 500;
      display: none;
    }

    .file-info.show {
      display: inline-block;
    }

    .file-list {
      margin-top: 1rem;
      padding-left: 0;
      list-style-type: none;
    }

    .file-list li {
      padding: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
      font-size: 0.9375rem;
      display: flex;
      justify-content: space-between;
    }

    .file-list li:last-child {
      border-bottom: none;
    }

    .merge-btn {
      margin-top: 1rem;
    }

    .mapping-group {
      margin-bottom: 2rem;
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-sm);
    }

    .mapping-group h3 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--gray-700);
    }

    .mapping-row {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .mapping-row label {
      min-width: 150px;
      font-weight: 500;
      color: var(--gray-700);
    }

    select, input[type="number"], input[type="text"] {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      min-width: 200px;
      background: white;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .options-section {
      margin-bottom: 2rem;
    }

    .option-group {
      margin-bottom: 1.5rem;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .checkbox-group input {
      margin-right: 0.75rem;
    }

    .checkbox-group label {
      font-weight: 500;
      color: var(--gray-700);
    }

    .gst-options {
      margin-top: 1rem;
      background: rgba(14, 165, 233, 0.05);
      border-left: 4px solid var(--info);
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .gst-options h4 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      color: var(--gray-700);
    }

    .gst-options label {
      display: inline-flex;
      align-items: center;
      margin-right: 1.5rem;
      font-size: 0.9375rem;
    }

    .gst-options input {
      margin-right: 0.5rem;
    }

    .commission-input {
      margin-top: 1rem;
      background: rgba(5, 150, 105, 0.05);
      border-left: 4px solid var(--secondary);
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .commission-input h4 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      color: var(--gray-700);
    }

    .commission-input input {
      width: 100px;
      margin-right: 0.5rem;
    }

    .analyze-btn {
      width: 100%;
      padding: 1rem;
      margin: 2rem 0;
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      border-top: 4px solid var(--primary);
    }

    .stat-card.warning {
      border-top-color: var(--warning);
    }

    .stat-card.danger {
      border-top-color: var(--danger);
    }

    .stat-card.success {
      border-top-color: var(--secondary);
    }

    .stat-card.info {
      border-top-color: var(--info);
    }

    .stat-card h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-600);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .stat-subtext {
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .alert-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .alert-box {
      background: white;
      border-left: 5px solid var(--warning);
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      height: 100%;
    }

    .alert-box.empty {
      background: var(--gray-50);
      border-left-color: var(--gray-400);
    }

    .alert-box.danger {
      border-left-color: var(--danger);
    }

    .alert-box.success {
      border-left-color: var(--secondary);
    }

    .alert-box.info {
      border-left-color: var(--info);
    }

    .alert-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--warning);
    }

    .alert-box.empty .alert-title {
      color: var(--gray-500);
    }

    .alert-box.danger .alert-title {
      color: var(--danger);
    }

    .alert-box.success .alert-title {
      color: var(--secondary);
    }

    .alert-box.info .alert-title {
      color: var(--info);
    }

    .alert-count {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--warning-dark);
      margin-bottom: 1rem;
    }

    .alert-box.empty .alert-count {
      color: var(--gray-500);
    }

    .alert-box.danger .alert-count {
      color: var(--danger);
    }

    .alert-box.success .alert-count {
      color: var(--secondary);
    }

    .alert-box.info .alert-count {
      color: var(--info);
    }

    .alert-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9375rem;
      margin-top: 1rem;
    }

    .alert-table th, .alert-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .alert-table th {
      background: var(--gray-50);
      color: var(--gray-700);
      font-weight: 600;
    }

    .alert-table tr:last-child td {
      border-bottom: none;
    }

    .amount-cell {
      text-align: right;
      font-family: 'Roboto Mono', monospace;
    }

    .amount-cell.positive {
      color: var(--secondary);
    }

    .amount-cell.negative {
      color: var(--danger);
    }

    .paid-cell {
      color: var(--secondary);
      font-weight: 600;
    }

    .unpaid-cell {
      color: var(--danger);
      font-weight: 600;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid rgba(99, 102, 241, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .error-message {
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
      border-radius: 0.5rem;
      display: none;
      border-left: 4px solid var(--danger);
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(5, 150, 105, 0.1);
      color: var(--secondary-dark);
      border-radius: 0.5rem;
      display: none;
      border-left: 4px solid var(--secondary);
    }

    .success-message.show {
      display: block;
    }

    .export-btn {
      margin-top: 1rem;
    }

    /* Manual Calculation Section */
    .manual-compare-section {
      margin-top: 2rem;
    }

    .manual-compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .manual-compare-box {
      background: var(--gray-50);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .manual-compare-box h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--gray-700);
    }

    .manual-compare-textarea {
      width: 100%;
      min-height: 200px;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-family: 'Roboto Mono', monospace;
      font-size: 0.875rem;
    }

    .manual-compare-btn {
      margin-top: 1rem;
      width: 100%;
    }

    .manual-compare-results {
      margin-top: 2rem;
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .manual-compare-results h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--gray-700);
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .result-table th, .result-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .result-table th {
      background: var(--gray-50);
      color: var(--gray-700);
      font-weight: 600;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--gray-200);
      margin-bottom: 1.5rem;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: var(--gray-600);
      transition: all 0.2s ease;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background-color: rgba(99, 102, 241, 0.05);
    }

    .tab:hover:not(.active) {
      color: var(--primary-dark);
      background-color: rgba(99, 102, 241, 0.05);
    }

    /* Source file info in results */
    .source-file-info {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
    }

    /* Enhanced commission display */
    .commission-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      background-color: rgba(5, 150, 105, 0.1);
      color: var(--secondary-dark);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        margin: 0;
        border-radius: 0;
      }
      
      .header {
        padding: 1.5rem;
      }
      
      .content-section {
        padding: 1.5rem;
      }
      
      .upload-section {
        grid-template-columns: 1fr;
      }
      
      .alert-container {
        grid-template-columns: 1fr;
      }
      
      .manual-compare-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info">User: ksismad | UTC 2025-06-20 20:51:09</div>
      <h1>🔍 Advanced App ID Analyzer Pro (Care4Sign)</h1>
      <p>Comprehensive Payment Reconciliation & Analysis Tool</p>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" data-content="main-analysis">Main Analysis</a>
      <a href="#" class="nav-item" data-content="manual-comparison">Manual Comparison</a>
    </nav>

    <!-- Main Analysis Section -->
    <div id="main-analysis" class="content-section active">
      <h2 class="section-title">Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 Files</h3>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" id="upload-btn-1">Choose Files</button>
          <div id="file-info-1" class="file-info"></div>
          <ul id="file-list-1" class="file-list"></ul>
          <button id="merge-btn-1" class="btn btn-info merge-btn" style="display:none;">Merge S1 Files</button>
        </div>
        <div class="upload-box source2" id="drop2">
          <h3>Source 2 File (Always Paid)</h3>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
          <button class="btn btn-secondary" id="upload-btn-2">Choose File</button>
          <div id="file-info-2" class="file-info"></div>
        </div>
      </div>
      
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Source 1)</h3>
        <div id="bp-code-filter">
          <p>Load a Source 1 file and map the 'BP Code' column to enable this filter.</p>
        </div>
      </div>

      <div id="column-mappings">
        <h2 class="section-title">Column Mappings & Options</h2>
        <div class="mapping-group">
          <div id="mapping-fields"></div>
        </div>
      </div>

      <div class="options-section">
        <h2 class="section-title">Analysis Options</h2>
        <div class="option-group">
          <div class="checkbox-group">
            <input type="checkbox" id="include-commission">
            <label for="include-commission">Include Commission Analysis</label>
          </div>
          
          <div class="gst-options">
            <h4>GST Options (S1 Only)</h4>
            <label><input type="checkbox" id="apply-gst"> Apply 18% GST to S1 amounts</label>
            <label><input type="checkbox" id="gst-round" disabled> Round GST amounts</label>
          </div>

          <div class="commission-input" id="commission-input" style="display: none;">
            <h4>Commission Analysis</h4>
            <label>
              Desired Commission Percentage:
              <input type="number" id="desired-commission" min="0" max="100" step="0.01" value="2.00"> %
            </label>
          </div>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <div id="success-message" class="success-message"></div>
      <button id="analyze-btn" class="btn btn-secondary analyze-btn" disabled>Analyze Data</button>

      <div id="results-section" style="display: none;">
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
          <div class="tab" data-tab="merged">Merged Data</div>
        </div>

        <div id="summary-view" class="tab-content active">
          <h2 class="section-title">Analysis Summary</h2>
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>

        <div id="detailed-view" class="tab-content">
          <h2 class="section-title">Detailed Results</h2>
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary export-btn">Export Detailed Report</button>
        </div>

        <div id="merged-view" class="tab-content">
          <h2 class="section-title">Merged Data View</h2>
          <div id="merged-results"></div>
          <button id="export-merged-btn" class="btn btn-secondary export-btn">Export Merged Data</button>
        </div>
      </div>
    </div>

    <!-- Manual Comparison Section -->
    <div id="manual-comparison" class="content-section">
      <h2 class="section-title">App ID Comparison</h2>
      <p>Enter App IDs to compare between Source 1 and Source 2</p>
      
      <div class="manual-compare-grid">
        <div class="manual-compare-box">
          <h3>Source 1 App IDs</h3>
          <textarea id="manual-s1-data" class="manual-compare-textarea" placeholder="Enter App IDs (one per line or comma separated)
Example:
APP123
APP456
APP789"></textarea>
          <button id="compare-manual-btn" class="btn btn-primary manual-compare-btn">Compare App IDs</button>
        </div>
        
        <div class="manual-compare-box">
          <h3>Source 2 App IDs</h3>
          <textarea id="manual-s2-data" class="manual-compare-textarea" placeholder="Enter App IDs (one per line or comma separated)
Example:
APP123
APP456
APP789"></textarea>
        </div>
      </div>
      
      <div class="manual-compare-results">
        <h3>Comparison Results</h3>
        <div id="manual-results-container">
          <p>Enter App IDs in both boxes and click "Compare App IDs" to see results</p>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Enhanced AppState management with validation
    const AppState = (() => {
      let state = {
        source1Files: [],
        source2Files: [],
        columnMappings: {},
        selectedBPCode: 'all', // NEW: For filtering
        analysisOptions: {
          includeCommission: false,
          applyGST: false,
          gstRound: false,
          desiredCommission: 2.0
        },
        analysisResults: null,
        mergedData: null
      };

      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        const required = ['appId', 'amount', 'date', 'bpCode', 'product']; // NEW: Added bpCode and product
        
        if (source1Files.length === 0 || source2Files.length === 0) {
          return false;
        }
        
        return required.every(id => {
          const mapping = columnMappings[id];
          return mapping && 
                 mapping.source1 !== undefined && mapping.source1 !== "" && 
                 // Allow S2 mappings to be optional for S1-only columns
                 (id === 'commission' || id === 'status' || id === 'bpCode' || id === 'product' || (mapping.source2 !== undefined && mapping.source2 !== ""));
        });
      };

      return {
        getState: () => ({ ...state }),
        setState: (newState) => { 
          state = { ...state, ...newState }; 
          return validateState();
        },
        resetAnalysis: () => { 
          state.analysisResults = null;
          state.mergedData = null;
        },
        isValid: validateState
      };
    })();

    // DOM References
    const DOM = {
      // Main Analysis
      fileInput1: document.getElementById('file-input-1'),
      fileInput2: document.getElementById('file-input-2'),
      uploadBtn1: document.getElementById('upload-btn-1'),
      uploadBtn2: document.getElementById('upload-btn-2'),
      drop1: document.getElementById('drop1'),
      drop2: document.getElementById('drop2'),
      fileInfo1: document.getElementById('file-info-1'),
      fileInfo2: document.getElementById('file-info-2'),
      fileList1: document.getElementById('file-list-1'),
      mergeBtn1: document.getElementById('merge-btn-1'),
      mappingFields: document.getElementById('mapping-fields'),
      includeCommission: document.getElementById('include-commission'),
      applyGST: document.getElementById('apply-gst'),
      gstRound: document.getElementById('gst-round'),
      desiredCommission: document.getElementById('desired-commission'),
      commissionInput: document.getElementById('commission-input'),
      analyzeBtn: document.getElementById('analyze-btn'),
      resultsSection: document.getElementById('results-section'),
      results: document.getElementById('results'),
      statsGrid: document.getElementById('stats-grid'),
      loadingOverlay: document.getElementById('loading-overlay'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      userInfo: document.getElementById('user-info'),
      exportDetailedBtn: document.getElementById('export-detailed-btn'),
      exportMergedBtn: document.getElementById('export-merged-btn'),
      detailedResults: document.getElementById('detailed-results'),
      mergedResults: document.getElementById('merged-results'),
      bpCodeFilterContainer: document.getElementById('bp-code-filter-container'), // NEW
      bpCodeFilter: document.getElementById('bp-code-filter'), // NEW
      
      // Manual Comparison
      manualS1Data: document.getElementById('manual-s1-data'),
      manualS2Data: document.getElementById('manual-s2-data'),
      compareManualBtn: document.getElementById('compare-manual-btn'),
      manualResultsContainer: document.getElementById('manual-results-container'),
      
      // Navigation
      navItems: document.querySelectorAll('.nav-item'),
      contentSections: document.querySelectorAll('.content-section'),
      
      // Tabs
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    // UI Manager for controlling UI state
    const UIManager = {
      resetAnalysisUI: () => {
        DOM.resultsSection.style.display = 'none';
        AppState.resetAnalysis();
        DOM.results.innerHTML = '';
        DOM.statsGrid.innerHTML = '';
        DOM.detailedResults.innerHTML = '';
        DOM.mergedResults.innerHTML = '';
        // Reset tabs to default
        const tabsContainer = DOM.resultsSection.querySelector('.tabs');
        tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabsContainer.querySelector('.tab[data-tab="summary"]').classList.add('active');
        DOM.resultsSection.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('summary-view').classList.add('active');
      }
    };

    // Utility Functions with enhanced error handling
    const Utils = {
      showLoading: () => DOM.loadingOverlay.classList.add('show'),
      hideLoading: () => DOM.loadingOverlay.classList.remove('show'),
      
      showError: (msg) => {
        console.error("Error:", msg);
        DOM.errorMessage.textContent = msg;
        DOM.errorMessage.classList.add('show');
        setTimeout(() => DOM.errorMessage.classList.remove('show'), 8000);
      },
      
      showSuccess: (msg) => {
        DOM.successMessage.textContent = msg;
        DOM.successMessage.classList.add('show');
        setTimeout(() => DOM.successMessage.classList.remove('show'), 5000);
      },
      
      updateUserInfo: () => {
        const now = new Date().toISOString().replace('T', ' ').slice(0, 19);
        DOM.userInfo.textContent = `User: ksismad | UTC ${now}`;
      },
      
      formatNumberForDisplay: (num, decimals = 2) => {
        if (typeof num !== 'number' || isNaN(num)) return num;
        return parseFloat(num.toFixed(decimals)).toLocaleString(undefined, {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      },
      
      findMatch: (headers, patterns) => {
        if (!headers || !patterns) return '';
        for (let pattern of patterns) {
          const index = headers.findIndex(h => h && pattern.test(String(h)));
          if (index !== -1) return index;
        }
        return '';
      },
      
      getS1Status: (row, statusIndex, commissionIndex) => {
        if (statusIndex !== undefined && statusIndex !== null && statusIndex !== "") {
            const statusValue = row[statusIndex];
            if (typeof statusValue === 'string') {
                const lowerStatus = statusValue.toLowerCase().trim();
                if (lowerStatus.includes('unpaid') || lowerStatus.includes('not paid') || lowerStatus === 'no' || lowerStatus === 'n') return "Unpaid";
                if (lowerStatus.includes('paid') || lowerStatus === 'yes' || lowerStatus === 'y') return "Paid";
            }
        }
        // Fall back to commission amount check
        if (commissionIndex !== undefined && commissionIndex !== null && commissionIndex !== "") {
          const commValue = row[commissionIndex];
          // In care4sign, commission is often the sum of multiple columns like "BP Co...".
          // The provided PDF shows 0.00 for paid items in "BP Co...", so this check is tricky.
          // Let's rely on the user to map a reliable status or commission column. 
          // For now, if commission is a number and > 0, it's paid.
          const numericValue = Utils.safeParseFloat(commValue);
          return (numericValue > 0) ? "Paid" : "Unpaid";
        }
        // Default to paid if no other info, as S1 is a sales report. Or default to unpaid to be safe. Let's be safe.
        return "Unpaid";
      },
      
      applyGSTToS1: (amount) => {
        if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
        const { applyGST, gstRound } = AppState.getState().analysisOptions;
        if (!applyGST) return amount;
        let result = amount * 1.18;
        return gstRound ? Math.round(result) : result;
      },
      
      safeParseFloat: (value) => {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          const cleaned = value.replace(/[^0-9.-]/g, '');
          return parseFloat(cleaned) || 0;
        }
        return 0;
      },
      
      calculateCommissionPercentage: (amount, commission) => {
        amount = Utils.safeParseFloat(amount);
        commission = Utils.safeParseFloat(commission);
        if (!amount || !commission || amount === 0) return 0;
        return (commission / amount) * 100;
      },
      
      generateUniqueId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
      parseAppIds: (text) => text.split(/[\n,]/).map(id => id.trim()).filter(id => id.length > 0),
      countOccurrences: (arr) => arr.reduce((acc, val) => (acc[val] = (acc[val] || 0) + 1, acc), {})
    };

    // File Handling
    const FileHandler = {
      init: () => {
        // Event listeners setup... (same as original)
        const optionInputs = [DOM.applyGST, DOM.gstRound, DOM.includeCommission, DOM.desiredCommission];
        optionInputs.forEach(input => input.onchange = FileHandler.handleOptionChange);
        DOM.uploadBtn1.onclick = e => { e.preventDefault(); DOM.fileInput1.value = ''; DOM.fileInput1.click(); };
        DOM.uploadBtn2.onclick = e => { e.preventDefault(); DOM.fileInput2.value = ''; DOM.fileInput2.click(); };
        DOM.fileInput1.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 1); };
        DOM.fileInput2.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 2); };
        [{ drop: DOM.drop1, src: 1 }, { drop: DOM.drop2, src: 2 }].forEach(o => {
          o.drop.ondragover = e => { e.preventDefault(); e.stopPropagation(); o.drop.classList.add('dragover'); };
          o.drop.ondragleave = e => { e.preventDefault(); e.stopPropagation(); o.drop.classList.remove('dragover'); };
          o.drop.ondrop = e => { 
            e.preventDefault(); e.stopPropagation();
            o.drop.classList.remove('dragover');
            if (e.dataTransfer.files.length) FileHandler.handleFileSelection(e.dataTransfer.files, o.src);
          };
        });
        DOM.mergeBtn1.onclick = FileHandler.showMergeDialog;
      },

      handleOptionChange: () => {
        const state = AppState.getState();
        AppState.setState({
            analysisOptions: {
                ...state.analysisOptions,
                applyGST: DOM.applyGST.checked,
                gstRound: DOM.gstRound.checked,
                includeCommission: DOM.includeCommission.checked,
                desiredCommission: parseFloat(DOM.desiredCommission.value) || 0
            }
        });
        DOM.gstRound.disabled = !DOM.applyGST.checked;
        if (!DOM.applyGST.checked) DOM.gstRound.checked = false;
        DOM.commissionInput.style.display = DOM.includeCommission.checked ? 'block' : 'none';
        UIManager.resetAnalysisUI();
        Analyzer.updateAnalyzeBtn();
      },
      
      handleFileSelection: async (files, src) => {
        UIManager.resetAnalysisUI();
        if (!files || files.length === 0) return Utils.showError('No files selected'); 
        if (src === 2 && files.length > 1) return Utils.showError('Source 2 can only accept one file.');
        
        Utils.showLoading();
        
        try {
          const fileArray = Array.from(files);
          const targetState = src === 1 ? 'source1Files' : 'source2Files';
          const fileListDOM = src === 1 ? DOM.fileList1 : null;
          const fileInfoDOM = src === 1 ? DOM.fileInfo1 : DOM.fileInfo2;
          
          AppState.setState({ [targetState]: [] });
          if (fileListDOM) fileListDOM.innerHTML = '';
          
          const processPromises = fileArray.map(file => 
            FileHandler.processExcelFile(file).then(data => ({ file, data })).catch(err => ({ file, error: err }))
          );
          
          const results = await Promise.all(processPromises);
          
          const successfulFiles = results.filter(r => !r.error).map(r => ({
            file: r.file, headers: r.data[0], records: r.data.slice(1),
            fileId: Utils.generateUniqueId(), fileName: r.file.name
          }));
          
          if (successfulFiles.length > 0) {
            AppState.setState({ [targetState]: successfulFiles });
            if (fileListDOM) {
              successfulFiles.forEach(f => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${f.fileName}</span><span>${f.records.length} rows</span>`;
                fileListDOM.appendChild(li);
              });
            }
            fileInfoDOM.textContent = `${successfulFiles.length} file(s) loaded`;
            fileInfoDOM.classList.add('show');
            if (src === 1) {
              DOM.mergeBtn1.style.display = successfulFiles.length > 1 ? 'inline-flex' : 'none';
              ColumnMapper.populateBPCodeFilter(); // NEW: Populate filter after S1 load
            }
          }
          
          ColumnMapper.setupColumnMappings();
          Analyzer.updateAnalyzeBtn();
          
        } catch (error) {
          Utils.showError(`Unexpected error during file handling: ${error.message}`);
        } finally {
          Utils.hideLoading();
        }
      },
      
      processExcelFile: (file) => new Promise((resolve, reject) => {
        // Same as original...
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!data || data.length < 2) return reject(new Error('File has no data rows.'));
            const cleanedData = data.filter(row => row.some(cell => cell !== null && cell !== ''))
                                   .map(row => row.map(cell => typeof cell === 'string' ? cell.trim() : cell));
            if (cleanedData.length < 2) return reject(new Error('File has no valid data rows.'));
            resolve(cleanedData);
          } catch (err) { reject(new Error(`Error parsing file: ${err.message}`)); }
        };
        reader.onerror = () => reject(new Error('Error reading file.'));
        reader.readAsArrayBuffer(file);
      }),
      
      showMergeDialog: () => { /* Same as original */ }
    };

    // Column Mapping
    const ColumnMapper = {
      setupColumnMappings: () => {
        const { source1Files, source2Files } = AppState.getState();
        const s1Headers = source1Files[0]?.headers || [];
        const s2Headers = source2Files[0]?.headers || [];
        
        if (s1Headers.length === 0 || s2Headers.length === 0) {
          DOM.mappingFields.innerHTML = '<p>Please load files for both sources to configure column mappings.</p>';
          return;
        }
        
        const columns = [
          // UPDATED with bpCode and product
          { id: 'appId', label: 'App ID (Application...)', patterns: [/app.*id/i, /applicati/i], required: true },
          { id: 'amount', label: 'Basic Amount (S1)', patterns: [/basic/i, /amount/i], s2: false, required: true },
          { id: 'bpCode', label: 'BP Code (S1)', patterns: [/bp.*code/i], s2: false, required: true },
          { id: 'product', label: 'Product Description (S1)', patterns: [/product/i], s2: false, required: true },
          { id: 'commission', label: 'Commission (S1)', patterns: [/commiss/i, /bp co/i, /deduction/i], s2: false },
          { id: 'status', label: 'Status (S1)', patterns: [/status/i, /paid/i], s2: false },
          { id: 'date', label: 'Date', patterns: [/date/i, /added ti/i], required: true },
          // A different amount for S2 if needed
          { id: 's2Amount', label: 'Amount (S2)', patterns: [/amount/i, /price/i], s1: false, required: true },
        ];
        
        let html = '';
        columns.forEach(col => {
          const s1Selected = col.s1 !== false ? Utils.findMatch(s1Headers, col.patterns) : null;
          const s2Selected = col.s2 !== false ? Utils.findMatch(s2Headers, col.patterns) : null;
          
          html += `<div class="mapping-row"><label>${col.label}${col.required ? ' *' : ''}:</label>`;
          
          if (col.s1 !== false) {
             html += `<select id="ms1-${col.id}" class="source-select" data-col="${col.id}" data-src="1">
                <option value="">Select S1 Column</option>
                ${s1Headers.map((h, i) => `<option value="${i}" ${s1Selected === i ? 'selected' : ''}>${h || `Column ${i + 1}`}</option>`).join('')}
              </select>`;
          }
           if (col.s2 !== false) {
             html += `<select id="ms2-${col.id}" class="source-select" data-col="${col.id}" data-src="2">
                <option value="">Select S2 Column</option>
                ${s2Headers.map((h, i) => `<option value="${i}" ${s2Selected === i ? 'selected' : ''}>${h || `Column ${i + 1}`}</option>`).join('')}
              </select>`;
          } else {
              html += `<span style="display:inline-block;min-width:200px;padding:8px;"></span>`;
          }
          html += '</div>';
        });
        
        DOM.mappingFields.innerHTML = html;
        document.querySelectorAll('.source-select').forEach(select => {
          select.addEventListener('change', ColumnMapper.updateColumnMappings);
        });
        ColumnMapper.updateColumnMappings();
      },
      
      updateColumnMappings: () => {
        UIManager.resetAnalysisUI();
        const columns = ['appId', 'amount', 'commission', 'status', 'date', 'bpCode', 'product', 's2Amount'];
        const mappings = {};
        
        columns.forEach(id => {
          mappings[id] = { 
            source1: document.getElementById(`ms1-${id}`)?.value || '', 
            source2: document.getElementById(`ms2-${id}`)?.value || ''
          };
        });
        
        AppState.setState({ columnMappings: mappings });
        ColumnMapper.populateBPCodeFilter(); // Re-populate in case mapping changed
        Analyzer.updateAnalyzeBtn();
      },

      populateBPCodeFilter: () => {
        const { source1Files, columnMappings } = AppState.getState();
        const bpCodeIndex = columnMappings.bpCode?.source1;

        if (source1Files.length === 0 || bpCodeIndex === undefined || bpCodeIndex === '') {
            DOM.bpCodeFilterContainer.style.display = 'none';
            return;
        }

        const allRecords = source1Files.flatMap(f => f.records);
        const uniqueBPCodes = [...new Set(allRecords.map(r => r[bpCodeIndex]).filter(Boolean))].sort();

        if (uniqueBPCodes.length === 0) {
            DOM.bpCodeFilterContainer.style.display = 'none';
            return;
        }

        let filterHtml = `
            <select id="bp-code-select" style="width: 100%;">
                <option value="all">All BP Codes</option>
                ${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}
            </select>
        `;
        DOM.bpCodeFilter.innerHTML = filterHtml;
        DOM.bpCodeFilterContainer.style.display = 'block';

        document.getElementById('bp-code-select').addEventListener('change', (e) => {
            AppState.setState({ selectedBPCode: e.target.value });
            UIManager.resetAnalysisUI();
        });
      }
    };

    // Analysis Logic
    const Analyzer = {
      updateAnalyzeBtn: () => {
        const isValid = AppState.isValid();
        DOM.analyzeBtn.disabled = !isValid;
        DOM.analyzeBtn.textContent = isValid ? 'Analyze Data' : 'Select Files & Required Mappings';
      },
      
      analyzeData: () => {
        try {
          const { source1Files, source2Files, columnMappings, analysisOptions, selectedBPCode } = AppState.getState();
          const s2 = source2Files[0];
          
          // NEW: Standard Price List
          const standardRates = {
            'CLASS_3_SIGNATURE_ENCRYPTION_1_YEAR': 1500.00, 'CLASS_3_SIGNATURE_ENCRYPTION_2_YEAR': 1680.00, 'CLASS_3_SIGNATURE_ENCRYPTION_3_YEAR': 2520.00,
            'CLASS_3_SIGNING_E_NCRYPTION_2_YEAR': 1680.00, // Alias for combo
            'CLASS_3_SIGNATURE_1_YEAR': 750.00, 'CLASS_3_SIGNATURE_2_YEAR': 840.00, 'CLASS_3_SIGNATURE_3_YEAR': 1260.00,
            'CLASS_3_SIGNING_2_YEAR': 840.00, // Alias
            'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_ENCRYPTION_1_YEAR': 7500.00, 'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_ENCRYPTION_2_YEAR': 10000.00, 'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_ENCRYPTION_3_YEAR': 15000.00,
            'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_1_YEAR': 3750.00, 'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_2_YEAR': 5000.00, 'CLASS_3_INDIVIDUAL_ORG_FOREIGN_SIGNATURE_3_YEAR': 7500.00,
          };
          const normalizeProductKey = (str) => {
              if (typeof str !== 'string') return '';
              return str.toUpperCase().replace(/[^A-Z0-9]/g, '_').replace(/_+/g, '_');
          };
          
          let combinedS1Records = source1Files.flatMap(file => 
            file.records.map(record => ({ ...record, sourceFile: file.fileName }))
          );
          
          // NEW: Filter by BP Code
          if (selectedBPCode && selectedBPCode !== 'all') {
              combinedS1Records = combinedS1Records.filter(r => r[columnMappings.bpCode.source1] === selectedBPCode);
          }
          
          const idx = {
            s1: _.mapValues(columnMappings, 'source1'),
            s2: _.mapValues(columnMappings, 'source2')
          };

          const scenarios = {
            "Price Exceeds Standard Rate": [], // NEW
            "S1 Paid but missing in S2": [], "S2 Paid but missing in S1": [],
            "S2 Paid, S1 Unpaid": [], "S2 Paid, S1 Paid but amount different": [],
            "Commission received higher than desired": [], "Commission received lower than desired": [],
            "Duplicates in S1": [], "Duplicates in S2": [],
          };
          
          let totalS1Commission = 0; // NEW
          
          const s2Map = new Map(s2.records.map(r => [String(r[idx.s2.appId]), r]));
          const s1Map = new Map();
          combinedS1Records.forEach(r => {
              const appId = String(r[idx.s1.appId]);
              if (appId) {
                  if (!s1Map.has(appId)) s1Map.set(appId, []);
                  s1Map.get(appId).push(r);
              }
          });

          const mergedData = [];
          
          s1Map.forEach((records, appId) => {
            records.forEach(r1 => {
              const s1Status = Utils.getS1Status(r1, idx.s1.status, idx.s1.commission);
              const commissionAmount = idx.s1.commission ? Utils.safeParseFloat(r1[idx.s1.commission]) : 0;
              const amount1Raw = Utils.safeParseFloat(r1[idx.s1.amount]);
              const amount1GST = Utils.applyGSTToS1(amount1Raw);
              
              if (s1Status === 'Paid') {
                  totalS1Commission += commissionAmount;
              }

              // NEW: Price Differential Check
              const productDesc = r1[idx.s1.product];
              const productKey = normalizeProductKey(productDesc);
              const standardRate = standardRates[productKey];
              if (standardRate !== undefined && amount1Raw > standardRate) {
                  scenarios["Price Exceeds Standard Rate"].push({
                      AppID: appId,
                      Product: productDesc,
                      BasicAmount: amount1Raw,
                      StandardRate: standardRate,
                      Difference: amount1Raw - standardRate,
                      BP_Code: r1[idx.s1.bpCode],
                      File: r1.sourceFile
                  });
              }

              // Continue with original analysis...
              const r2 = s2Map.get(appId);
              if (r2) {
                const amount2 = Utils.safeParseFloat(r2[idx.s2.s2Amount]);
                const amountDiff = Math.abs(amount2 - amount1GST) > 0.01;
                const commonData = { AppID: appId, S1_Amount: amount1GST, S2_Amount: amount2, Difference: (amount2 - amount1GST), S1_Date: r1[idx.s1.date], S2_Date: r2[idx.s2.date], S1_File: r1.sourceFile };
                if (s1Status === "Paid" && amountDiff) {
                    scenarios["S2 Paid, S1 Paid but amount different"].push(commonData);
                } else if (s1Status !== "Paid") {
                    scenarios["S2 Paid, S1 Unpaid"].push(commonData);
                }
              } else if (s1Status === "Paid") {
                scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_Amount: amount1GST, S1_Date: r1[idx.s1.date], S1_File: r1.sourceFile });
              }
            });
          });

          s2Map.forEach((r2, appId) => {
            if (!s1Map.has(appId)) {
                scenarios["S2 Paid but missing in S1"].push({ AppID: appId, S2_Amount: Utils.safeParseFloat(r2[idx.s2.s2Amount]), S2_Date: r2[idx.s2.date] });
            }
          });
          
          // Duplicates and other checks remain same...
          const s1Counts = _.countBy(combinedS1Records, r => String(r[idx.s1.appId]));
          for (const [id, count] of Object.entries(s1Counts)) { if (count > 1) scenarios['Duplicates in S1'].push({ AppID: id, Count: count }); }
          const s2Counts = _.countBy(s2.records, r => String(r[idx.s2.appId]));
          for (const [id, count] of Object.entries(s2Counts)) { if (count > 1) scenarios['Duplicates in S2'].push({ AppID: id, Count: count }); }

          
          AppState.setState({ analysisResults: { ...scenarios, totalS1Commission } }); // Pass commission total
          return { ...scenarios, totalS1Commission };

        } catch (error) {
          Utils.showError(`Analysis failed: ${error.message}`);
          console.error(error);
          return {};
        }
      },
      
      displayResults: (results) => {
        const { analysisOptions, totalS1Commission } = results;

        const orderedScenarios = [
          "Price Exceeds Standard Rate", // NEW
          "S1 Paid but missing in S2", "S2 Paid but missing in S1", "S2 Paid, S1 Unpaid",
          "S2 Paid, S1 Paid but amount different",
          "Duplicates in S1", "Duplicates in S2"
        ];
        
        const stats = { totalAlerts: 0, totalAmountDiscrepancies: 0, totalMissingRecords: 0, totalAmountDifference: 0 };
        orderedScenarios.forEach(s => {
            const records = results[s] || [];
            if(records.length === 0) return;
            stats.totalAlerts += records.length;
            if (s.includes("amount different")) {
                stats.totalAmountDiscrepancies += records.length;
                stats.totalAmountDifference += records.reduce((sum, r) => sum + (r.Difference || 0), 0);
            } else if (s.includes("missing")) stats.totalMissingRecords += records.length;
        });
        
        DOM.statsGrid.innerHTML = `
          <div class="stat-card danger"><h3>Total Alerts</h3><div class="stat-value">${stats.totalAlerts}</div><div class="stat-subtext">Potential issues found</div></div>
          <div class="stat-card warning"><h3>Price Over-runs (S1)</h3><div class="stat-value">${results["Price Exceeds Standard Rate"]?.length || 0}</div><div class="stat-subtext">Basic price > standard rate</div></div>
          <div class="stat-card info"><h3>Missing Records</h3><div class="stat-value">${stats.totalMissingRecords}</div><div class="stat-subtext">Records in one source only</div></div>
          <div class="stat-card ${stats.totalAmountDifference >= 0 ? 'success' : 'danger'}"><h3>Net Amount Difference</h3><div class="stat-value">${Utils.formatNumberForDisplay(stats.totalAmountDifference)}</div><div class="stat-subtext">S2 vs S1 total difference</div></div>
          <div class="stat-card success"><h3>Total S1 Commission</h3><div class="stat-value">${Utils.formatNumberForDisplay(totalS1Commission)}</div><div class="stat-subtext">Sum of mapped commission</div></div>
        `;
        
        let summaryHtml = '';
        orderedScenarios.forEach(scenarioName => {
            const records = results[scenarioName] || [];
            const isEmpty = records.length === 0;
            // NEW: color for new scenario
            let boxClass = 'alert-box' + (isEmpty ? ' empty' : (scenarioName.includes('missing in S2') || scenarioName.includes('Price Exceeds') ? ' danger' : (scenarioName.includes('missing in S1') || scenarioName.includes('Duplicates') ? ' warning' : ' info')));
            summaryHtml += `<div class="${boxClass}"><div class="alert-title">${scenarioName}</div><div class="alert-count">${records.length} records</div>`;
            if (!isEmpty) {
                const headers = Object.keys(records[0]).filter(h => !/file/i.test(h) && h !== 'Status');
                summaryHtml += `<table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>`;
                records.slice(0, 5).forEach(rec => {
                    summaryHtml += `<tr>${headers.map(h => {
                        let val = rec[h];
                        let cls = '';
                        if (typeof val === 'number') {
                            cls = 'amount-cell';
                            if (h === 'Difference' || h === 'Percentage') cls += val < 0 ? ' negative' : ' positive';
                            val = Utils.formatNumberForDisplay(val);
                        }
                        return `<td class="${cls}">${val || 'N/A'}</td>`;
                    }).join('')}</tr>`;
                });
                summaryHtml += `</tbody></table>`;
                if (records.length > 5) summaryHtml += `<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);">+ ${records.length - 5} more records</div>`;
            } else {
                summaryHtml += `<div style="color:var(--gray-500);font-style:italic;margin-top:0.5rem;">No records found</div>`;
            }
            summaryHtml += `</div>`;
        });
        DOM.results.innerHTML = summaryHtml;
        
        // Detailed and Merged views logic remains the same.
        
        DOM.resultsSection.style.display = 'block';
        DOM.resultsSection.scrollIntoView({ behavior: 'smooth' });
        Utils.showSuccess("Analysis completed successfully.");
      },
      
      exportToExcel: (data, fileName) => { /* Same as original */ },
      exportDetailedResults: () => {
          const { analysisResults } = AppState.getState();
          if (!analysisResults) return Utils.showError("No analysis results to export.");
          // Remove total commission from export sheets
          const { totalS1Commission, ...scenarios } = analysisResults;
          const sheets = Object.entries(scenarios).map(([name, records]) => ({ name, records }));
          Analyzer.exportToExcel(sheets, "Care4Sign_Detailed_Report");
      },
      exportMergedData: () => { /* Same as original */ }
    };

    // Manual Comparison
    const ManualComparison = {
      // All manual comparison logic remains the same as original
      compareAppIds: () => {
        const s1AppIds = Utils.parseAppIds(DOM.manualS1Data.value);
        const s2AppIds = Utils.parseAppIds(DOM.manualS2Data.value);
        if (s1AppIds.length === 0 && s2AppIds.length === 0) return Utils.showError("Please enter App IDs in at least one source.");
        
        try {
            const s1Set = new Set(s1AppIds);
            const s2Set = new Set(s2AppIds);
            const s1Counts = Utils.countOccurrences(s1AppIds);
            const s2Counts = Utils.countOccurrences(s2AppIds);
            const results = {
                "Duplicates in Source 1": Object.entries(s1Counts).filter(([, count]) => count > 1).map(([appId, count]) => ({ AppID: appId, Occurrences: count })),
                "Duplicates in Source 2": Object.entries(s2Counts).filter(([, count]) => count > 1).map(([appId, count]) => ({ AppID: appId, Occurrences: count })),
                "Only in Source 1": [...s1Set].filter(id => !s2Set.has(id)).map(id => ({ AppID: id, Count: s1Counts[id] })),
                "Only in Source 2": [...s2Set].filter(id => !s1Set.has(id)).map(id => ({ AppID: id, Count: s2Counts[id] })),
                "Common App IDs": [...s1Set].filter(id => s2Set.has(id)).map(id => ({ AppID: id, 'S1 Count': s1Counts[id], 'S2 Count': s2Counts[id] }))
            };
            ManualComparison.displayResults(results, s1AppIds.length, s2AppIds.length);
        } catch (error) { Utils.showError(`Error comparing App IDs: ${error.message}`); }
      },
      displayResults: (results, s1Total, s2Total) => { /* Same as original */ }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      try {
        FileHandler.init();
        Utils.updateUserInfo();
        setInterval(Utils.updateUserInfo, 15000);
        
        DOM.analyzeBtn.addEventListener('click', () => {
          Utils.showLoading();
          setTimeout(() => {
            try {
              const results = Analyzer.analyzeData();
              if (Object.keys(results).length) Analyzer.displayResults(results);
            } catch (error) {
              Utils.showError(`Analysis failed: ${error.message}`);
              console.error(error);
            } finally {
              Utils.hideLoading();
            }
          }, 10);
        });
        
        DOM.exportDetailedBtn.addEventListener('click', Analyzer.exportDetailedResults);
        DOM.exportMergedBtn.addEventListener('click', Analyzer.exportMergedData);
        DOM.compareManualBtn.addEventListener('click', ManualComparison.compareAppIds);
        
        DOM.navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const contentId = item.getAttribute('data-content');
            DOM.navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            DOM.contentSections.forEach(sec => sec.classList.toggle('active', sec.id === contentId));
          });
        });
        
        DOM.tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            const parentSection = tab.closest('.content-section');
            parentSection.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            parentSection.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `${tabName}-view`));
          });
        });
        
        console.log("Advanced App ID Analyzer Pro (Care4Sign) Initialized");
      } catch (error) {
        console.error("Initialization error:", error);
        document.body.innerHTML = `<div style="padding: 2rem; color: #dc2626; font-size: 1.2rem;">Application failed to initialize. Please check the console. Error: ${error.message}</div>`;
      }
    });
  </script>
</body>
</html>
