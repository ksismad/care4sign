<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #059669; --danger: #dc2626;
      --warning: #f59e0b; --info: #3b82f6; --gray-50: #f9fafb; --gray-100: #f3f4f6;
      --gray-200: #e5e7eb; --gray-300: #d1d5db; --gray-500: #6b7280; --gray-700: #374151;
      --gray-800: #1f2937; --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
      --highlight-bg: rgba(253, 242, 213, 0.7);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--gray-100); color: var(--gray-800); font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
    .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; position: relative; }
    .header h1 { margin: 0 0 0.5rem; font-size: 2.25rem; font-weight: 700; }
    .header p { opacity: 0.9; font-size: 1.1rem; }
    .user-info { position: absolute; top: 1rem; right: 2rem; background: rgba(255,255,255,.15); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
    .content-section { padding: 2rem; }
    .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--gray-800); font-weight: 600; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;}
    .section-title .filter-badge { font-size: .9rem; font-weight: 500; background-color: var(--info); color: white; padding: .25rem .75rem; border-radius: 999px; margin-left: 1rem; }
    .upload-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .upload-box { background: var(--gray-100); border: 2px dashed var(--gray-300); border-radius: .75rem; padding: 1.5rem; transition: all .2s ease; position: relative; }
    .upload-box h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .upload-box-content { display: flex; align-items: center; gap: 1rem; }
    .file-input { display: none; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600; cursor: pointer; transition: all .2s ease; border: none; user-select: none; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn:disabled { background: var(--gray-300); color: var(--gray-500); cursor: not-allowed; transform: none; box-shadow: none; }
    .file-info { padding: .75rem 1rem; background: rgba(5,150,105,.1); color: var(--secondary-dark); border-radius: .5rem; font-size: .9375rem; font-weight: 500; }
    .mapping-group { margin-bottom: 2rem; background: var(--gray-50); padding: 1.5rem; border-radius: .75rem; box-shadow: var(--shadow-sm); }
    .mapping-row { display: flex; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .mapping-row.commission-row { align-items: flex-start; }
    .commission-checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: .5rem 1rem; background: white; padding: 1rem; border: 1px solid var(--gray-200); border-radius: .5rem; flex-grow: 1; }
    .commission-checkbox-group label { display: flex; align-items: center; font-weight: normal; min-width: auto; }
    .commission-checkbox-group input { margin-right: .5rem; }
    .mapping-row label { min-width: 200px; font-weight: 500; color: var(--gray-700); }
    select, input[type="number"] { padding: .5rem .75rem; border: 1px solid var(--gray-300); border-radius: .5rem; font-size: .9375rem; min-width: 220px; background: white; }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.2); }
    .options-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .gst-options, .commission-input { margin-top: 1rem; padding: 1rem; border-radius: .5rem; }
    .gst-options { background: rgba(14,165,233,.05); border-left: 4px solid var(--info); }
    .commission-input { background: rgba(245,158,11,.05); border-left: 4px solid var(--warning); }
    .gst-options h4, .commission-input h4 { margin-top: 0; margin-bottom: .75rem; font-size: 1.1rem; color: var(--gray-700); }
    .gst-options label { display: inline-flex; align-items: center; margin-right: 1.5rem; }
    .analyze-btn { width: 100%; padding: 1rem; margin: 2rem 0; font-size: 1.25rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
    .stat-card { background: white; padding: 1.5rem; border-radius: .75rem; box-shadow: var(--shadow); border-top: 4px solid var(--primary); }
    .stat-card.warning { border-top-color: var(--warning); }
    .stat-card.danger { border-top-color: var(--danger); }
    .stat-card.success { border-top-color: var(--secondary); }
    .stat-card.info { border-top-color: var(--info); }
    .stat-card h3 { margin-top: 0; margin-bottom: .5rem; font-size: 1rem; font-weight: 600; color: var(--gray-500); }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-800); }
    .alert-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .alert-box { background: white; border-left: 5px solid var(--warning); border-radius: .75rem; box-shadow: var(--shadow); padding: 1.5rem; height: 100%; }
    .alert-box.empty { background: var(--gray-50); border-left-color: var(--gray-300); }
    .alert-box.danger { border-left-color: var(--danger); }
    .alert-title { font-size: 1.2rem; font-weight: 700; margin-bottom: .5rem; }
    .alert-box.empty .alert-title { color: var(--gray-500); }
    .alert-count { font-size: 1.25rem; font-weight: 800; margin-bottom: 1rem; }
    .alert-table { width: 100%; border-collapse: collapse; font-size: .9375rem; margin-top: 1rem; }
    .alert-table th, .alert-table td { padding: .75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .alert-table th { background: var(--gray-50); color: var(--gray-700); font-weight: 600; }
    .amount-cell { text-align: right; font-family: 'Roboto Mono', monospace; }
    .diff-cell { background-color: var(--highlight-bg); }
    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,.9); display: flex; flex-direction:column; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity .3s ease; }
    .loading-overlay.show { visibility: visible; opacity: 1; }
    .spinner { width: 3rem; height: 3rem; border: 4px solid rgba(99,102,241,.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    #loading-message { margin-top: 1rem; color: var(--gray-700); font-weight: 500;}
    .error-message { margin: 1rem 0; padding: 1rem; background: rgba(220,38,38,.1); color: var(--danger); border-radius: .5rem; display: none; border-left: 4px solid var(--danger); }
    .error-message.show { display: block; }
    .export-btn { margin-top: 1rem; }
    .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab { padding: .75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray-500); transition: all .2s ease; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .paid-cell { color: var(--secondary); font-weight: 600; }
    .unpaid-cell { color: var(--danger); font-weight: 600; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info">User: ksismad</div>
      <h1><span style="font-size: 2.5rem;">ðŸš€</span> Advanced App ID Analyzer Pro</h1>
      <p>Professional Reconciliation & Analysis for Care4Sign</p>
    </div>

    <main id="main-analysis" class="content-section active">
      <h2 class="section-title">1. Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 (Your Report)</h3>
          <div class="upload-box-content">
            <button class="btn btn-primary" id="upload-btn-1">Choose File(s)</button>
            <div id="file-info-1" style="display:none;"></div>
          </div>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
        </div>
        <div class="upload-box" id="drop2">
          <h3>Source 2 (Paid Source)</h3>
           <div class="upload-box-content">
            <button class="btn btn-secondary" id="upload-btn-2">Choose File</button>
            <div id="file-info-2" style="display:none;"></div>
          </div>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
        </div>
      </div>
      
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Optional)</h3>
        <div id="bp-code-filter"></div>
      </div>

      <h2 class="section-title">2. Column Mappings</h2>
      <div id="column-mappings" class="mapping-group">
        <div id="mapping-fields"><p>Please load files for both sources to configure mappings.</p></div>
      </div>

      <h2 class="section-title">3. Analysis Options</h2>
      <div class="options-section">
        <div class="gst-options">
          <h4>GST Options</h4>
          <label><input type="checkbox" id="apply-gst"> Apply 18% GST to S1 Basic Amount for comparison</label>
          <label><input type="checkbox" id="gst-round" disabled> Round GST amounts</label>
        </div>
        <div class="commission-input">
          <h4>Commission Analysis</h4>
          <label for="desired-commission">Desired Commission Percentage:</label>
          <input type="number" id="desired-commission" min="0" max="100" step="0.01" value="5.00"> %
          <small style="display:block; color: var(--gray-500)">This is calculated against the S1 Basic Amount.</small>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <button id="analyze-btn" class="btn btn-primary analyze-btn" disabled title="Please load files and map all required columns.">Analyze Data</button>

      <div id="results-section" style="display: none;">
        <h2 class="section-title" id="summary-title">
          <span>Analysis Summary</span>
          <button id="reset-btn" class="btn btn-secondary">Start New Analysis</button>
        </h2>
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
          <div class="tab" data-tab="merged">Merged Data</div>
        </div>
        <div id="summary-view" class="tab-content active">
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>
        <div id="detailed-view" class="tab-content">
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary export-btn">Export Detailed Report</button>
        </div>
        <div id="merged-view" class="tab-content">
          <div id="merged-results"></div>
          <button id="export-merged-btn" class="btn btn-secondary export-btn">Export Merged Data</button>
        </div>
      </div>
    </main>
  </div>

  <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
      <div id="loading-message"></div>
  </div>
  
  <script id="worker-script" type="javascript/worker">
    // This script content will be used to create the Web Worker
    self.importScripts("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");

    self.onmessage = (event) => {
        try {
            const { fileBuffer, fileName } = event.data;
            const wb = self.XLSX.read(new Uint8Array(fileBuffer), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            if (!ws) throw new Error(`Sheet not found in ${fileName}`);
            
            const data = self.XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!data || data.length < 2) throw new Error(`No data rows in ${fileName}`);

            const cleanedData = data.filter(row => row.some(cell => cell !== null && cell !== ''));
            self.postMessage({ success: true, data: cleanedData });
        } catch (error) {
            self.postMessage({ success: false, error: error.message });
        }
    };
  </script>

  <script>
    // --- STATE & CORE ---
    const AppState = (() => {
      let state = {};
      const getInitialState = () => ({
        source1Files: [], source2Files: [],
        columnMappings: { commission: { source1: [] } },
        selectedBPCode: 'all',
        analysisOptions: { applyGST: false, gstRound: false, desiredCommission: 5.0 },
        analysisResults: null, mergedData: null,
      });

      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        if (source1Files.length === 0) return "Source 1 file is missing.";
        if (source2Files.length === 0) return "Source 2 file is missing.";
        
        const s1Required = ['appId', 'amount', 'date', 'bpCode', 'product', 'priceInclGST'];
        const s2Required = ['appId', 's2Amount'];
        const missingS1 = s1Required.filter(id => !columnMappings[id]?.source1);
        const missingS2 = s2Required.filter(id => !columnMappings[id]?.source2);
        if (missingS1.length > 0 || missingS2.length > 0) return "Please map all required (*) columns.";
        if (columnMappings.commission?.source1?.length === 0) return "Please select at least one commission column.";
        return true;
      };

      return {
        init: () => { state = getInitialState(); },
        getState: () => ({ ...state }),
        setState: (newState) => { state = { ...state, ...newState }; },
        isValid: validateState
      };
    })();

    // --- DOM & UI ---
    const DOM = {
      ...[...document.querySelectorAll('[id]')].reduce((acc, el) => ({ ...acc, [el.id.replace(/-./g, m => m[1].toUpperCase())]: el }), {}),
      tabs: document.querySelectorAll('.tab'),
    };

    const UIManager = {
      resetUI: () => {
        AppState.init();
        DOM.fileInfo1.style.display = 'none';
        DOM.fileInfo2.style.display = 'none';
        DOM.bpCodeFilterContainer.style.display = 'none';
        DOM.mappingFields.innerHTML = '<p>Please load files for both sources to configure mappings.</p>';
        DOM.resultsSection.style.display = 'none';
        DOM.analyzeBtn.disabled = true;
        DOM.analyzeBtn.title = "Please load files and map all required columns.";
        DOM.errorMessage.classList.remove('show');
      },
      setLoading: (isLoading, message = '') => {
        DOM.loadingMessage.textContent = message;
        DOM.loadingOverlay.classList.toggle('show', isLoading);
      },
      showError: (msg) => { console.error("Error:", msg); DOM.errorMessage.textContent = msg; DOM.errorMessage.classList.add('show'); },
    };

    // --- UTILITIES ---
    const Utils = {
      formatNumber: (num, dec = 2) => (typeof num !== 'number' || isNaN(num)) ? (num ?? 'N/A') : num.toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec }),
      findMatch: (headers, patterns) => {
        if (!headers || !patterns) return '';
        for (const p of patterns) {
          const idx = headers.findIndex(h => h && p.test(String(h)));
          if (idx !== -1) return idx;
        }
        return '';
      },
      safeParseFloat: (v) => (typeof v === 'number') ? v : parseFloat(String(v).replace(/[^0-9.-]/g, '')) || 0,
      getS1Status: (row, statusIndex) => {
        if (statusIndex && String(row[statusIndex]).toLowerCase().includes('unpaid')) return "Unpaid";
        return "Paid";
      },
    };

    // --- FILE HANDLING (with Web Worker) ---
    const FileHandler = {
      worker: null,
      init: () => {
          const workerBlob = new Blob([document.getElementById('worker-script').textContent], { type: "application/javascript" });
          FileHandler.worker = new Worker(URL.createObjectURL(workerBlob));
          
          DOM.uploadBtn1.onclick = () => DOM.fileInput1.click();
          DOM.uploadBtn2.onclick = () => DOM.fileInput2.click();
          DOM.fileInput1.onchange = e => e.target.files.length && FileHandler.handleFileSelection(e.target.files, 1);
          DOM.fileInput2.onchange = e => e.target.files.length && FileHandler.handleFileSelection(e.target.files, 2);
          [DOM.applyGst, DOM.gstRound, DOM.desiredCommission].forEach(el => el.onchange = FileHandler.handleOptionChange);
      },
      handleOptionChange: () => {
          const applyGST = DOM.applyGst.checked;
          DOM.gstRound.disabled = !applyGST;
          if (!applyGST) DOM.gstRound.checked = false;
          AppState.setState({ analysisOptions: { applyGST, gstRound: DOM.gstRound.checked, desiredCommission: Utils.safeParseFloat(DOM.desiredCommission.value) }});
      },
      handleFileSelection: async (files, src) => {
        UIManager.setLoading(true, `Processing ${files[0].name}...`);
        try {
          const results = await Promise.all(Array.from(files).map(f => FileHandler.processFileWithWorker(f)));
          const successfulFiles = results.map((data, i) => ({ data, headers: data[0], records: data.slice(1), fileName: files[i].name }));
          
          const targetState = src === 1 ? 'source1Files' : 'source2Files';
          AppState.setState({ [targetState]: successfulFiles });
          
          const infoDOM = src === 1 ? DOM.fileInfo1 : DOM.fileInfo2;
          infoDOM.textContent = `${successfulFiles.length} file(s) loaded.`;
          infoDOM.style.display = 'block';

          if (src === 1) ColumnMapper.populateBPCodeFilter();
          ColumnMapper.setupColumnMappings();
        } catch (error) { UIManager.showError(error.message); } 
        finally { UIManager.setLoading(false); }
      },
      processFileWithWorker: (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            FileHandler.worker.postMessage({ fileBuffer: e.target.result, fileName: file.name });
            FileHandler.worker.onmessage = (event) => {
                if (event.data.success) {
                    resolve(event.data.data);
                } else {
                    reject(new Error(event.data.error));
                }
            };
            FileHandler.worker.onerror = (err) => reject(new Error(`Worker error: ${err.message}`));
        };
        reader.onerror = () => reject(new Error(`Could not read ${file.name}`));
        reader.readAsArrayBuffer(file);
      }),
    };

    // --- COLUMN MAPPING ---
    const ColumnMapper = {
      setupColumnMappings: () => {
        const { source1Files, source2Files } = AppState.getState();
        const s1Headers = source1Files[0]?.headers || [];
        const s2Headers = source2Files[0]?.headers || [];
        if (s1Headers.length === 0 || s2Headers.length === 0) return;

        const columns = [
          { id: 'appId', label: 'App ID', patterns: [/app.*id/i, /applicati/i], s1: true, s2: true, req: true },
          { id: 'amount', label: 'S1 Basic Amount', patterns: [/basic/i], s1: true, req: true },
          { id: 'priceInclGST', label: 'S1 Price incl. GST', patterns: [/price.*gst/i, /price i/i], s1: true, req: true },
          { id: 's2Amount', label: 'S2 Paid Amount', patterns: [/amount/i, /price/i, /total/i, /value/i], s2: true, req: true },
          { id: 'bpCode', label: 'S1 BP Code', patterns: [/bp.*code/i], s1: true, req: true },
          { id: 'product', label: 'S1 Product Description', patterns: [/product/i], s1: true, req: true },
          { id: 'date', label: 'S1 Date', patterns: [/date/i, /added ti/i], s1: true, req: true },
          { id: 'status', label: 'S1 Status (Optional)', patterns: [/status/i], s1: true },
          { id: 'commission', label: 'S1 Commission Columns', patterns: [/amount/i], s1: true, req: true },
        ];
        
        DOM.mappingFields.innerHTML = columns.map(col => {
            let fieldHtml = '';
            if (col.id === 'commission') {
                const autoSelected = s1Headers.map((h, i) => Utils.findMatch([h], col.patterns) === 0 ? i : -1).filter(i => i !== -1);
                fieldHtml = `<div class="commission-checkbox-group">${s1Headers.map((h, i) => `<label><input type="checkbox" class="commission-checkbox" value="${i}" ${autoSelected.includes(i) ? 'checked' : ''}>${h || `Col ${i+1}`}</label>`).join('')}</div>`;
            } else {
                const s1Match = Utils.findMatch(s1Headers, col.patterns);
                const s2Match = Utils.findMatch(s2Headers, col.patterns);
                if (col.s1) fieldHtml += `<select data-col="${col.id}" data-src="1"><option value="">Select S1 Column</option>${s1Headers.map((h, i) => `<option value="${i}" ${s1Match === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
                if (col.s2) fieldHtml += `<select data-col="${col.id}" data-src="2"><option value="">Select S2 Column</option>${s2Headers.map((h, i) => `<option value="${i}" ${s2Match === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
            }
            return `<div class="mapping-row ${col.id === 'commission' ? 'commission-row' : ''}"><label>${col.label}${col.req ? ' *' : ''}:</label>${fieldHtml}</div>`;
        }).join('');
        
        document.querySelectorAll('select, .commission-checkbox').forEach(el => el.onchange = ColumnMapper.updateColumnMappings);
        ColumnMapper.updateColumnMappings();
      },
      updateColumnMappings: () => {
        const mappings = { commission: { source1: [] } };
        document.querySelectorAll('select[data-col]').forEach(sel => {
            const id = sel.dataset.col;
            if (!mappings[id]) mappings[id] = {};
            mappings[id][sel.dataset.src === '1' ? 'source1' : 'source2'] = sel.value;
        });
        mappings.commission.source1 = [...document.querySelectorAll('.commission-checkbox:checked')].map(cb => cb.value);
        AppState.setState({ columnMappings: mappings });
        Analyzer.updateAnalyzeBtn();
      },
      populateBPCodeFilter: () => {
        const { source1Files } = AppState.getState();
        const bpCodeIndex = Utils.findMatch(source1Files[0]?.headers, [/bp.*code/i]);
        if (bpCodeIndex === '') { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
        
        const uniqueBPCodes = [...new Set(source1Files.flatMap(f => f.records).map(r => r[bpCodeIndex]).filter(Boolean))].sort();
        if (uniqueBPCodes.length === 0) { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
        
        DOM.bpCodeFilter.innerHTML = `<select id="bp-code-select" style="width: 100%;"><option value="all">All BP Codes</option>${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}</select>`;
        DOM.bpCodeFilterContainer.style.display = 'block';
        DOM.bpCodeSelect.onchange = (e) => { AppState.setState({ selectedBPCode: e.target.value }); };
      }
    };

    // --- ANALYSIS ENGINE ---
    const Analyzer = {
      updateAnalyzeBtn: () => {
        const validationResult = AppState.isValid();
        DOM.analyzeBtn.disabled = validationResult !== true;
        DOM.analyzeBtn.title = validationResult === true ? "Run Analysis" : validationResult;
      },
      run: () => {
        UIManager.setLoading(true, "Analyzing data...");
        setTimeout(() => {
          try {
            const results = Analyzer.analyzeData();
            Analyzer.displayResults(results);
          } catch (error) { UIManager.showError(`Analysis failed: ${error.message}`); console.error(error); } 
          finally { UIManager.setLoading(false); }
        }, 10);
      },
      analyzeData: () => {
        const { source1Files, source2Files, columnMappings, selectedBPCode, analysisOptions } = AppState.getState();
        const s2 = source2Files[0];
        
        const standardRates = { 'CLASS_3_SIGNING_2_YEAR': 840, 'CLASS_3_ENCRYPTION_2_YEAR': 840, 'CLASS_3_SIGNING_ENCRYPTION_2_YEAR': 1680, 'CLASS_3_SIGNING_3_YEAR': 1260, 'CLASS_3_ENCRYPTION_3_YEAR': 1260, 'CLASS_3_SIGNING_ENCRYPTION_3_YEAR': 2520, 'CLASS_3_SIGNING_1_YEAR': 750, 'CLASS_3_ENCRYPTION_1_YEAR': 750, 'CLASS_3_SIGNING_ENCRYPTION_1_YEAR': 1500 };
        const normalizeKey = (str) => String(str).toUpperCase().replace(/[^A-Z0-9]/g, '_').replace(/_+/g, '_');
        
        let s1Records = source1Files.flatMap(f => f.records.map(r => ({...r, fileName: f.fileName})));
        if (selectedBPCode !== 'all') {
            s1Records = s1Records.filter(r => String(r[columnMappings.bpCode.source1]) === String(selectedBPCode));
        }

        const idx = columnMappings;
        const scenarios = Object.fromEntries(["Price Exceeds Standard Rate", "S1 GST Calculation Mismatch", "S1 Paid but missing in S2", "S2 Paid but missing in S1", "S2 Paid, S1 Paid but amount different", "Commission received higher than desired", "Commission received lower than desired", "Duplicates in S1", "Duplicates in S2", "S1 Marked Paid but Commission Missing", "S1 Marked Unpaid but Commission Exists"].map(k => [k, []]));
        const mergedData = [];
        const s2Map = new Map(s2.records.map(r => [String(r[idx.appId.source2]), r]));
        let totalCommission = 0;
        
        s1Records.forEach(r1 => {
            const appId = String(r1[idx.appId.source1]);
            const basicAmount = Utils.safeParseFloat(r1[idx.amount.source1]);
            const commission = idx.commission.source1.reduce((sum, i) => sum + Utils.safeParseFloat(r1[i]), 0);
            totalCommission += commission;
            const status = Utils.getS1Status(r1, idx.status?.source1);
            
            // Checks
            const standardRate = standardRates[normalizeKey(r1[idx.product.source1])];
            if (standardRate !== undefined && basicAmount > standardRate) scenarios["Price Exceeds Standard Rate"].push({ AppID: appId, Product: r1[idx.product.source1], BasicAmount: basicAmount, StandardRate: standardRate, Difference: basicAmount - standardRate });
            
            const s1GstFromFile = Utils.safeParseFloat(r1[idx.priceInclGST.source1]);
            if(analysisOptions.applyGST){
                const s1GstCalculated = analysisOptions.gstRound ? Math.round(basicAmount * 1.18) : (basicAmount * 1.18);
                if (Math.abs(s1GstCalculated - s1GstFromFile) > 0.01) scenarios["S1 GST Calculation Mismatch"].push({ AppID: appId, Calculated: s1GstCalculated, FromFile: s1GstFromFile, Difference: s1GstFromFile - s1GstCalculated });
            }
            
            const desiredComm = (analysisOptions.desiredCommission / 100) * basicAmount;
            if (commission > desiredComm + 0.01) scenarios["Commission received higher than desired"].push({ AppID: appId, Received: commission, Desired: desiredComm, Difference: commission - desiredComm });
            if (commission < desiredComm - 0.01) scenarios["Commission received lower than desired"].push({ AppID: appId, Received: commission, Desired: desiredComm, Difference: commission - desiredComm });
            
            if (idx.status?.source1) {
                if (status === 'Paid' && commission === 0) scenarios["S1 Marked Paid but Commission Missing"].push({ AppID: appId });
                if (status === 'Unpaid' && commission > 0) scenarios["S1 Marked Unpaid but Commission Exists"].push({ AppID: appId, Commission: commission });
            }

            const r2 = s2Map.get(appId);
            if (r2) {
                const s2Amount = Utils.safeParseFloat(r2[idx.s2Amount.source2]);
                if (Math.abs(s1GstFromFile - s2Amount) > 0.01) scenarios["S2 Paid, S1 Paid but amount different"].push({ AppID: appId, S1_Price: s1GstFromFile, S2_Price: s2Amount, Difference: s2Amount - s1GstFromFile });
            } else {
                scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_Price: s1GstFromFile });
            }
            mergedData.push({ AppID: appId, Source: 'S1', Status: status, Basic_Amount: basicAmount, GST_Price: s1GstFromFile, Commission: commission, File: r1.fileName });
        });
        
        const s1AppIds = new Set(s1Records.map(r => String(r[idx.appId.source1])));
        s2Map.forEach((r2, appId) => {
            if (!s1AppIds.has(appId)) scenarios["S2 Paid but missing in S1"].push({ AppID: appId, S2_Price: Utils.safeParseFloat(r2[idx.s2Amount.source2]) });
            mergedData.push({ AppID: appId, Source: 'S2', Status: 'Paid', GST_Price: Utils.safeParseFloat(r2[idx.s2Amount.source2]), File: s2.fileName });
        });
        
        _.countBy(s1Records, r => String(r[idx.appId.source1])).forEach((c, id) => { if(c > 1) scenarios["Duplicates in S1"].push({ AppID: id, Count: c}); });
        _.countBy(s2.records, r => String(r[idx.appId.source2])).forEach((c, id) => { if(c > 1) scenarios["Duplicates in S2"].push({ AppID: id, Count: c}); });
        
        AppState.setState({ analysisResults: { ...scenarios, totalCommission }, mergedData: _.sortBy(mergedData, 'AppID') });
        return { ...scenarios, totalCommission };
      },
      displayResults: (results) => {
        const { selectedBPCode } = AppState.getState();
        if (selectedBPCode !== 'all') { DOM.summaryTitle.querySelector('span').innerHTML = `Analysis Summary <span class="filter-badge">Filtered by: ${selectedBPCode}</span>`; }
        
        DOM.statsGrid.innerHTML = `
          <div class="stat-card danger"><h3>Total Alerts</h3><div class="stat-value">${Object.values(results).reduce((s, a) => s + (Array.isArray(a) ? a.length : 0), 0)}</div></div>
          <div class="stat-card success"><h3>Total S1 Commission</h3><div class="stat-value">${Utils.formatNumber(results.totalCommission)}</div></div>
          <div class="stat-card warning"><h3>Price Over-runs</h3><div class="stat-value">${results["Price Exceeds Standard Rate"].length}</div></div>
          <div class="stat-card danger"><h3>Amount Mismatches</h3><div class="stat-value">${results["S2 Paid, S1 Paid but amount different"].length}</div></div>`;
        
        let summaryHtml = '', detailedHtml = '';
        Object.entries(results).filter(([_, v]) => Array.isArray(v)).forEach(([name, records]) => {
            const isEmpty = records.length === 0;
            const headers = isEmpty ? [] : Object.keys(records[0]);
            
            const buildRow = (rec) => `<tr>${headers.map(h => `<td class="${typeof rec[h] === 'number' ? 'amount-cell' : ''} ${h.toLowerCase().includes('difference') ? 'diff-cell' : ''}">${Utils.formatNumber(rec[h])}</td>`).join('')}</tr>`;

            summaryHtml += `<div class="alert-box ${isEmpty ? 'empty' : 'info'}"><div class="alert-title">${name}</div><div class="alert-count">${records.length} records</div>`;
            if (!isEmpty) {
                summaryHtml += `<table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>${records.slice(0, 5).map(buildRow).join('')}</tbody></table>`;
                if (records.length > 5) summaryHtml += `<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);">+ ${records.length - 5} more</div>`;
            }
            summaryHtml += `</div>`;
            
            if (!isEmpty) {
                detailedHtml += `<h3 style="margin-top:2rem; color: var(--gray-700);">${name} (${records.length})</h3><div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>${records.map(buildRow).join('')}</tbody></table></div>`;
            }
        });
        
        DOM.results.innerHTML = summaryHtml;
        DOM.detailedResults.innerHTML = detailedHtml || '<p>No issues found in detailed results.</p>';
        
        const { mergedData } = AppState.getState();
        const mergedHeaders = ["AppID", "Source", "Status", "Basic_Amount", "GST_Price", "Commission", "File"];
        DOM.mergedResults.innerHTML = `<div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${mergedHeaders.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>` +
          mergedData.map(rec => `<tr>${mergedHeaders.map(h => `<td class="${typeof rec[h] === 'number' ? 'amount-cell' : (rec.Status === 'Paid' ? 'paid-cell' : 'unpaid-cell')}">${Utils.formatNumber(rec[h])}</td>`).join('')}</tr>`).join('') + `</tbody></table></div>`;

        DOM.resultsSection.style.display = 'block';
      },
      exportToExcel: (isMerged = false) => {
          const { analysisResults, mergedData } = AppState.getState();
          const { totalCommission, ...scenarios } = analysisResults || {};
          const dataToExport = isMerged ? [{ name: "Merged_Data", records: mergedData }] : Object.entries(scenarios).map(([name, records]) => ({ name, records })).filter(s => s.records.length > 0);

          if (!dataToExport || dataToExport.length === 0) return UIManager.showError("No data to export.");
          UIManager.setLoading(true, "Generating Excel file...");
          setTimeout(() => {
            try {
              const wb = XLSX.utils.book_new();
              dataToExport.forEach(sheet => {
                const ws = XLSX.utils.json_to_sheet(sheet.records);
                XLSX.utils.book_append_sheet(wb, ws, sheet.name.substring(0, 31));
              });
              XLSX.writeFile(wb, `Care4Sign_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch (e) { UIManager.showError(`Export failed: ${e.message}`); } 
            finally { UIManager.setLoading(false); }
          }, 10);
      }
    };
    
    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      try {
        AppState.init();
        FileHandler.init();
        Utils.updateUserInfo();
        setInterval(Utils.updateUserInfo, 30000);
        
        DOM.analyzeBtn.onclick = Analyzer.run;
        DOM.resetBtn.onclick = UIManager.resetUI;
        DOM.exportDetailedBtn.onclick = () => Analyzer.exportToExcel(false);
        DOM.exportMergedBtn.onclick = () => Analyzer.exportToExcel(true);
        
        DOM.tabs.forEach(tab => tab.onclick = () => {
            const parent = tab.closest('#results-section');
            parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            parent.querySelectorAll('.tab-content').forEach(c => c.style.display = c.id.startsWith(tab.dataset.tab) ? 'block' : 'none');
        });
      } catch (error) {
        console.error("Initialization error:", error);
        document.body.innerHTML = `<div style="padding:2rem;color:red;font-size:1.2rem;">Application failed to start. Error: ${error.message}</div>`;
      }
    });
  </script>
</body>
</html>
