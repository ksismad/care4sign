<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #059669;
      --secondary-dark: #047857;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--gray-100); color: var(--gray-800); font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: var(--shadow-xl); }
    .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; position: relative; }
    .header h1 { margin: 0 0 0.5rem; font-size: 2.25rem; font-weight: 700; }
    .header p { opacity: 0.9; font-size: 1.1rem; }
    .user-info { position: absolute; top: 1rem; right: 2rem; background: rgba(255, 255, 255, 0.15); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; }
    .nav-menu { background: var(--gray-800); display: flex; padding: 0 2rem; }
    .nav-item { padding: 1rem 1.5rem; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s ease; border-bottom: 3px solid transparent; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
    .nav-item.active { background: rgba(255, 255, 255, 0.05); border-bottom-color: var(--primary); }
    .content-section { padding: 2rem; display: none; }
    .content-section.active { display: block; }
    .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--gray-800); font-weight: 600; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; }
    .section-title .filter-badge { font-size: 0.9rem; font-weight: 500; background-color: var(--info); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; margin-left: 1rem; vertical-align: middle; }
    .upload-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .upload-box { background: var(--gray-100); border: 2px dashed var(--gray-300); border-radius: 0.75rem; padding: 1.5rem; position: relative; }
    .upload-box.source2 { border-color: var(--secondary); background: rgba(5, 150, 105, 0.05); }
    .upload-box.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
    .file-input { display: none; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; user-select: none; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:disabled { background: var(--gray-300); color: var(--gray-500); cursor: not-allowed; transform: none; box-shadow: none; }
    .file-info { margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(5, 150, 105, 0.1); color: var(--secondary-dark); border-radius: 0.5rem; display: none; }
    .file-info.show { display: inline-block; }
    .file-list { margin-top: 1rem; padding-left: 0; list-style-type: none; }
    .file-list li { padding: 0.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; }
    .mapping-group { margin-bottom: 2rem; background: var(--gray-50); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow-sm); }
    .mapping-group h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .mapping-row { display: flex; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .mapping-row.commission-row { align-items: flex-start; }
    .commission-checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem 1rem; background: white; padding: 1rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; flex-grow: 1; }
    .commission-checkbox-group label { display: flex; align-items: center; font-weight: normal; min-width: auto; }
    .commission-checkbox-group input { margin-right: 0.5rem; }
    .mapping-row label { min-width: 180px; font-weight: 500; color: var(--gray-700); }
    select, input[type="number"] { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; min-width: 220px; background: white; }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    .options-section { margin-bottom: 2rem; }
    .gst-options, .commission-input { margin-top: 1rem; border-left: 4px solid var(--info); padding: 1rem; border-radius: 0.5rem; }
    .gst-options { background: rgba(14, 165, 233, 0.05); }
    .commission-input { background: rgba(5, 150, 105, 0.05); border-left-color: var(--secondary); }
    .analyze-btn { width: 100%; padding: 1rem; margin: 2rem 0; font-size: 1.1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow); border-top: 4px solid var(--primary); }
    .stat-card.warning { border-top-color: var(--warning); } .stat-card.danger { border-top-color: var(--danger); } .stat-card.success { border-top-color: var(--secondary); } .stat-card.info { border-top-color: var(--info); }
    .stat-card h3 { margin: 0 0 0.5rem; font-size: 1rem; color: var(--gray-600); }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
    .alert-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .alert-box { background: white; border-left: 5px solid var(--warning); border-radius: 0.75rem; box-shadow: var(--shadow); padding: 1.5rem; height: 100%; }
    .alert-box.empty { background: var(--gray-50); border-left-color: var(--gray-400); } .alert-box.danger { border-left-color: var(--danger); } .alert-box.success { border-left-color: var(--secondary); } .alert-box.info { border-left-color: var(--info); }
    .alert-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--warning); }
    .alert-box.empty .alert-title { color: var(--gray-500); } .alert-box.danger .alert-title { color: var(--danger); } .alert-box.success .alert-title { color: var(--secondary); } .alert-box.info .alert-title { color: var(--info); }
    .alert-count { font-size: 1.25rem; font-weight: 800; margin-bottom: 1rem; }
    .alert-table { width: 100%; border-collapse: collapse; font-size: 0.9375rem; margin-top: 1rem; }
    .alert-table th, .alert-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .alert-table th { background: var(--gray-50); font-weight: 600; }
    .amount-cell { text-align: right; font-family: 'Roboto Mono', monospace; }
    .amount-cell.positive { color: var(--secondary); } .amount-cell.negative { color: var(--danger); }
    .loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
    .loading-overlay.show { visibility: visible; opacity: 1; }
    .spinner { width: 3rem; height: 3rem; border: 4px solid rgba(99, 102, 241, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .error-message { margin: 1rem 0; padding: 1rem; background: rgba(220, 38, 38, 0.1); color: var(--danger); border-radius: 0.5rem; display: none; border-left: 4px solid var(--danger); }
    .error-message.show { display: block; }
    .manual-compare-textarea { width: 100%; min-height: 200px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; }
    .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray-600); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info"></div>
      <h1>üîç Advanced App ID Analyzer Pro (Care4Sign)</h1>
      <p>Comprehensive Payment Reconciliation & Analysis Tool</p>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" data-content="main-analysis">Main Analysis</a>
      <a href="#" class="nav-item" data-content="manual-comparison">Manual Comparison</a>
    </nav>

    <!-- Main Analysis Section -->
    <div id="main-analysis" class="content-section active">
      <h2 class="section-title">1. Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 Files (Your Report)</h3>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" onclick="this.previousElementSibling.click()">Choose Files</button>
          <div id="file-info-1" class="file-info"></div>
          <ul id="file-list-1" class="file-list"></ul>
        </div>
        <div class="upload-box source2" id="drop2">
          <h3>Source 2 File (Paid Source)</h3>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" onclick="this.previousElementSibling.click()">Choose File</button>
          <div id="file-info-2" class="file-info"></div>
        </div>
      </div>
      
      <h2 class="section-title">2. Filters & Mappings</h2>
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Source 1)</h3>
        <div id="bp-code-filter"></div>
      </div>
      <div id="column-mappings" class="mapping-group">
        <h3>Column Mappings</h3>
        <div id="mapping-fields"><p>Please load files for both sources to configure mappings.</p></div>
      </div>

      <h2 class="section-title">3. Analysis Options</h2>
      <div class="options-section">
         <div class="gst-options">
            <h4>GST Options (Applied to S1 Basic Amount)</h4>
            <label><input type="checkbox" id="apply-gst"> Apply 18% GST</label>
            <label><input type="checkbox" id="gst-round" disabled> Round final GST amounts</label>
        </div>
        <div class="commission-input" id="commission-input-container" style="display: none;">
            <h4>Commission Analysis</h4>
            <label>
              Desired Commission Percentage:
              <input type="number" id="desired-commission" min="0" max="100" step="0.01" value="5.00"> %
            </label>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <button id="analyze-btn" class="btn btn-primary analyze-btn" disabled>Analyze Data</button>

      <div id="results-section" style="display: none;">
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
          <div class="tab" data-tab="merged">Merged Data</div>
        </div>
        <div id="summary-view" class="tab-content active">
          <h2 class="section-title" id="summary-title">Analysis Summary</h2>
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>
        <div id="detailed-view" class="tab-content">
          <h2 class="section-title">Detailed Results</h2>
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary">Export Detailed Report</button>
        </div>
        <div id="merged-view" class="tab-content">
            <h2 class="section-title">Merged Data View</h2>
            <div id="merged-results"></div>
            <button id="export-merged-btn" class="btn btn-primary">Export Merged Data</button>
        </div>
      </div>
    </div>

    <!-- Manual Comparison Section -->
    <div id="manual-comparison" class="content-section">
        <h2 class="section-title">Manual App ID Comparison</h2>
        <div class="upload-section">
            <div class="mapping-group" style="width:100%"><textarea id="manual-s1-data" class="manual-compare-textarea" placeholder="Paste App IDs from Source 1..."></textarea></div>
            <div class="mapping-group" style="width:100%"><textarea id="manual-s2-data" class="manual-compare-textarea" placeholder="Paste App IDs from Source 2..."></textarea></div>
        </div>
        <button id="compare-manual-btn" class="btn btn-primary">Compare Lists</button>
        <div id="manual-results-container" style="margin-top: 2rem;"></div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>

  <script>
    const AppState = (() => {
      let state = {
        source1Files: [], source2Files: [],
        columnMappings: { commission: { source1: [] } },
        selectedBPCode: 'all', analysisResults: null, mergedData: null,
        analysisOptions: { applyGST: false, gstRound: false, desiredCommission: 5.0 }
      };
      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        if (source1Files.length === 0 || source2Files.length === 0) return false;
        const s1Req = ['appId', 'amount', 'date', 'bpCode', 'product', 'priceInclGST'];
        const s2Req = ['appId', 's2Amount'];
        const s1Valid = s1Req.every(id => columnMappings[id]?.source1);
        const s2Valid = s2Req.every(id => columnMappings[id]?.source2);
        const commissionValid = columnMappings.commission?.source1?.length > 0;
        return s1Valid && s2Valid && commissionValid;
      };
      return {
        getState: () => ({ ...state }),
        setState: (newState) => { state = { ...state, ...newState }; },
        isValid: validateState,
        resetAnalysis: () => { state.analysisResults = null; state.mergedData = null; }
      };
    })();

    const DOM = {
        fileInput1: document.getElementById('file-input-1'), fileInput2: document.getElementById('file-input-2'),
        fileInfo1: document.getElementById('file-info-1'), fileInfo2: document.getElementById('file-info-2'),
        fileList1: document.getElementById('file-list-1'), mappingFields: document.getElementById('mapping-fields'),
        bpCodeFilterContainer: document.getElementById('bp-code-filter-container'), bpCodeFilter: document.getElementById('bp-code-filter'),
        applyGST: document.getElementById('apply-gst'), gstRound: document.getElementById('gst-round'),
        commissionInputContainer: document.getElementById('commission-input-container'), desiredCommission: document.getElementById('desired-commission'),
        analyzeBtn: document.getElementById('analyze-btn'), resultsSection: document.getElementById('results-section'),
        summaryTitle: document.getElementById('summary-title'), statsGrid: document.getElementById('stats-grid'),
        results: document.getElementById('results'), detailedResults: document.getElementById('detailed-results'),
        mergedResults: document.getElementById('merged-results'), exportDetailedBtn: document.getElementById('export-detailed-btn'),
        exportMergedBtn: document.getElementById('export-merged-btn'), loadingOverlay: document.getElementById('loading-overlay'),
        errorMessage: document.getElementById('error-message'), userInfo: document.getElementById('user-info'),
        navItems: document.querySelectorAll('.nav-item'), contentSections: document.querySelectorAll('.content-section'),
        tabs: document.querySelectorAll('.tab'), tabContents: document.querySelectorAll('.tab-content'),
        manualS1Data: document.getElementById('manual-s1-data'), manualS2Data: document.getElementById('manual-s2-data'),
        compareManualBtn: document.getElementById('compare-manual-btn'), manualResultsContainer: document.getElementById('manual-results-container'),
    };
    
    const UIManager = {
      resetAnalysisUI: () => { DOM.resultsSection.style.display = 'none'; AppState.resetAnalysis(); DOM.summaryTitle.innerHTML = 'Analysis Summary'; },
      updateAnalyzeBtn: () => { const isValid = AppState.isValid(); DOM.analyzeBtn.disabled = !isValid; DOM.analyzeBtn.textContent = isValid ? 'Analyze Data' : 'Select Files & Required Mappings'; }
    };

    const Utils = {
      showLoading: () => DOM.loadingOverlay.classList.add('show'),
      hideLoading: () => DOM.loadingOverlay.classList.remove('show'),
      showError: (msg) => { console.error("Error:", msg); DOM.errorMessage.textContent = msg; DOM.errorMessage.style.display = 'block'; setTimeout(() => DOM.errorMessage.style.display = 'none', 8000); },
      updateUserInfo: () => { const now = new Date().toISOString().replace('T', ' ').slice(0, 19); DOM.userInfo.textContent = `User: ksismad | UTC ${now}`; },
      formatNumber: (num, dec = 2) => (typeof num !== 'number' || isNaN(num)) ? num : parseFloat(num.toFixed(dec)).toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec }),
      safeParseFloat: (v) => (typeof v === 'number') ? v : parseFloat(String(v).replace(/[^0-9.-]/g, '')) || 0,
      findMatch: (headers, patterns) => { for (let p of patterns) { const i = headers.findIndex(h => h && p.test(String(h))); if (i !== -1) return i; } return ''; },
    };

    const FileHandler = {
        init: () => {
            ['drop1', 'drop2'].forEach((id, index) => {
                const el = document.getElementById(id);
                el.onclick = () => DOM[`fileInput${index + 1}`].click();
                el.ondragover = e => { e.preventDefault(); e.stopPropagation(); el.classList.add('dragover'); };
                el.ondragleave = e => { e.preventDefault(); e.stopPropagation(); el.classList.remove('dragover'); };
                el.ondrop = e => { e.preventDefault(); e.stopPropagation(); el.classList.remove('dragover'); if (e.dataTransfer.files.length) FileHandler.handleFileSelection(e.dataTransfer.files, index + 1); };
            });
            DOM.fileInput1.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 1); };
            DOM.fileInput2.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 2); };
            [DOM.applyGST, DOM.gstRound, DOM.desiredCommission].forEach(el => el.onchange = FileHandler.handleOptionChange);
        },
        handleOptionChange: () => {
            const opts = { applyGST: DOM.applyGST.checked, gstRound: DOM.gstRound.checked, desiredCommission: Utils.safeParseFloat(DOM.desiredCommission.value) };
            DOM.gstRound.disabled = !opts.applyGST;
            if (!opts.applyGST) DOM.gstRound.checked = false; opts.gstRound = DOM.gstRound.checked;
            AppState.setState({ analysisOptions: opts });
            UIManager.resetAnalysisUI();
        },
        handleFileSelection: async (files, src) => {
            UIManager.resetAnalysisUI();
            if (src === 2 && files.length > 1) return Utils.showError('Source 2 only accepts one file.');
            Utils.showLoading();
            try {
                const results = await Promise.all(Array.from(files).map(f => FileHandler.processExcelFile(f).catch(e => ({ error: e, file: f }))));
                const successfulFiles = results.filter(r => !r.error).map(r => ({ ...r, headers: r.data[0], records: r.data.slice(1) }));
                if (successfulFiles.length > 0) {
                    const targetState = `source${src}Files`;
                    AppState.setState({ [targetState]: successfulFiles });
                    DOM[`fileInfo${src}`].textContent = `${successfulFiles.length} file(s) loaded.`;
                    DOM[`fileInfo${src}`].classList.add('show');
                    if (src === 1) {
                        DOM.fileList1.innerHTML = successfulFiles.map(f => `<li>${f.file.name} (${f.records.length} rows)</li>`).join('');
                        ColumnMapper.populateBPCodeFilter();
                    }
                }
                results.filter(r => r.error).forEach(r => Utils.showError(`Failed to process ${r.file.name}: ${r.error.message}`));
            } catch (error) { Utils.showError(`File handling error: ${error.message}`); } 
            finally { ColumnMapper.setupColumnMappings(); Utils.hideLoading(); }
        },
        processExcelFile: (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                    if (!data || data.length < 2) return reject(new Error('File has no data rows.'));
                    resolve({ file, data });
                } catch (err) { reject(new Error(`Error parsing file: ${err.message}`)); }
            };
            reader.onerror = () => reject(new Error('Error reading file.'));
            reader.readAsArrayBuffer(file);
        }),
    };

    const ColumnMapper = {
        setupColumnMappings: () => {
            const { source1Files, source2Files } = AppState.getState();
            const s1Headers = source1Files[0]?.headers || [];
            const s2Headers = source2Files[0]?.headers || [];
            if (s1Headers.length === 0 || s2Headers.length === 0) return;

            const columns = [
                { id: 'appId', label: 'App ID (Application...)', p: [/app.*id/i, /applicati/i], s1: true, s2: true },
                { id: 'amount', label: 'Basic Amount (S1)', p: [/basic/i], s1: true },
                { id: 'priceInclGST', label: 'Price incl. GST (S1)', p: [/price.*gst/i], s1: true },
                { id: 's2Amount', label: 'Amount (S2)', p: [/amount/i, /price/i], s2: true },
                { id: 'bpCode', label: 'BP Code (S1)', p: [/bp.*code/i], s1: true },
                { id: 'product', label: 'Product Description (S1)', p: [/product/i], s1: true },
                { id: 'commission', label: 'Commission Columns (S1)', p: [/platin/i, /bp co/i, /bp wis/i], s1: true },
                { id: 'date', label: 'Date (S1)', p: [/date/i, /added ti/i], s1: true },
            ];
            
            let html = '';
            columns.forEach(col => {
                html += `<div class="mapping-row ${col.id === 'commission' ? 'commission-row' : ''}"><label>${col.label} *:</label>`;
                if (col.id === 'commission') {
                    const autoChecked = s1Headers.map((h, i) => col.p.some(p => p.test(h)) ? i : -1).filter(i => i !== -1);
                    html += `<div class="commission-checkbox-group">${s1Headers.map((h, i) => `<label><input type="checkbox" class="commission-checkbox" value="${i}" ${autoChecked.includes(i) ? 'checked' : ''}>${h || `Col ${i+1}`}</label>`).join('')}</div>`;
                } else {
                    if (col.s1) html += `<select id="ms1-${col.id}" data-col="${col.id}" data-src="1"><option value="">Select S1 Column</option>${s1Headers.map((h, i) => `<option value="${i}" ${Utils.findMatch(s1Headers, col.p) === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
                    if (col.s2) html += `<select id="ms2-${col.id}" data-col="${col.id}" data-src="2"><option value="">Select S2 Column</option>${s2Headers.map((h, i) => `<option value="${i}" ${Utils.findMatch(s2Headers, col.p) === i ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
                }
                html += '</div>';
            });
            DOM.mappingFields.innerHTML = html;
            document.querySelectorAll('select, .commission-checkbox').forEach(el => el.onchange = ColumnMapper.updateColumnMappings);
            ColumnMapper.updateColumnMappings();
        },
        updateColumnMappings: () => {
            UIManager.resetAnalysisUI();
            const mappings = { commission: { source1: [] } };
            document.querySelectorAll('select[data-col]').forEach(sel => {
                const id = sel.dataset.col; const src = sel.dataset.src === '1' ? 'source1' : 'source2';
                if (!mappings[id]) mappings[id] = {};
                mappings[id][src] = sel.value;
            });
            mappings.commission.source1 = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);
            AppState.setState({ columnMappings: mappings });
            DOM.commissionInputContainer.style.display = 'block';
            UIManager.updateAnalyzeBtn();
        },
        populateBPCodeFilter: () => {
            const { source1Files, columnMappings } = AppState.getState();
            const bpCodeIndex = columnMappings.bpCode?.source1;
            if (source1Files.length === 0 || !bpCodeIndex) { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
            const uniqueBPCodes = [...new Set(source1Files.flatMap(f => f.records).map(r => r[bpCodeIndex]).filter(Boolean))].sort();
            if (uniqueBPCodes.length === 0) { DOM.bpCodeFilterContainer.style.display = 'none'; return; }
            DOM.bpCodeFilter.innerHTML = `<select id="bp-code-select" style="width: 100%;"><option value="all">All BP Codes</option>${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}</select>`;
            DOM.bpCodeFilterContainer.style.display = 'block';
            document.getElementById('bp-code-select').onchange = (e) => { AppState.setState({ selectedBPCode: e.target.value }); UIManager.resetAnalysisUI(); };
        }
    };
    
    const Analyzer = {
        analyzeData: () => {
            try {
                const { source1Files, source2Files, columnMappings: idx, selectedBPCode, analysisOptions: opts } = AppState.getState();
                const standardRates = { 'CLASS 3 SIGNING 2 YEAR': 840, 'CLASS 3 ENCRYPTION 2 YEAR': 840, 'CLASS 3 SIGNING/ENCRYPTION 2 YEAR': 1680, 'CLASS 3 SIGNING 3 YEAR': 1260, 'CLASS 3 ENCRYPTION 3 YEAR': 1260, 'CLASS 3 SIGNING/ENCRYPTION 3 YEAR': 2520, 'CLASS 3 SIGNING 1 YEAR': 750, 'CLASS 3 ENCRYPTION 1 YEAR': 750, 'CLASS 3 SIGNING/ENCRYPTION 1 YEAR': 1500 };
                let s1Records = source1Files.flatMap(f => f.records.map(r => ({ ...r, sourceFile: f.name })));
                if (selectedBPCode !== 'all') { s1Records = s1Records.filter(r => String(r[idx.bpCode.source1]) === String(selectedBPCode)); }
                
                const scenarios = { "Price Exceeds Standard Rate": [], "S1 Records with Zero Commission": [], "Commission received higher than desired": [], "Commission received lower than desired": [], "Price incl GST Mismatch (S1 vs Calc)": [], "Price incl GST Mismatch (S1 vs S2)": [], "S1 Paid but missing in S2": [], "S2 Paid but missing in S1": [], "Duplicates in S1": [] };
                const mergedData = [], s2Map = new Map(source2Files[0].records.map(r => [String(r[idx.appId.source2]), r]));
                
                s1Records.forEach(r1 => {
                    const appId = String(r1[idx.appId.source1]);
                    const basicAmount = Utils.safeParseFloat(r1[idx.amount.source1]);
                    const commission = idx.commission.source1.reduce((sum, i) => sum + Utils.safeParseFloat(r1[i]), 0);
                    const product = String(r1[idx.product.source1] || '').trim().toUpperCase();
                    const priceInclGST = Utils.safeParseFloat(r1[idx.priceInclGST.source1]);
                    
                    const mergedS1 = { AppID: appId, Source: 'S1', BasicAmount: basicAmount, Commission: commission, PriceInclGST_S1: priceInclGST, BP_Code: r1[idx.bpCode.source1], File: r1.sourceFile };
                    
                    if (standardRates[product] && basicAmount > standardRates[product]) { scenarios["Price Exceeds Standard Rate"].push({ AppID: appId, Product: product, BasicAmount: basicAmount, StandardRate: standardRates[product], Difference: basicAmount - standardRates[product] }); }
                    if (commission === 0) { scenarios["S1 Records with Zero Commission"].push({ AppID: appId, BasicAmount: basicAmount }); }
                    
                    const desiredComm = (opts.desiredCommission / 100) * basicAmount;
                    const commDiff = commission - desiredComm;
                    if (commDiff > 0.01) { scenarios["Commission received higher than desired"].push({ AppID: appId, Commission: commission, Desired: desiredComm, Difference: commDiff }); }
                    else if (commDiff < -0.01) { scenarios["Commission received lower than desired"].push({ AppID: appId, Commission: commission, Desired: desiredComm, Difference: commDiff }); }

                    let expectedGSTPrice = basicAmount;
                    if(opts.applyGST) { expectedGSTPrice *= 1.18; if(opts.gstRound) expectedGSTPrice = Math.round(expectedGSTPrice); }
                    if (Math.abs(priceInclGST - expectedGSTPrice) > 0.01) { scenarios["Price incl GST Mismatch (S1 vs Calc)"].push({ AppID: appId, S1_GST_Price: priceInclGST, Calculated_GST_Price: expectedGSTPrice, Difference: priceInclGST - expectedGSTPrice }); }

                    const r2 = s2Map.get(appId);
                    if (r2) {
                        const s2Amount = Utils.safeParseFloat(r2[idx.s2Amount.source2]);
                        mergedS1.S2_Amount = s2Amount;
                        if (Math.abs(priceInclGST - s2Amount) > 0.01) { scenarios["Price incl GST Mismatch (S1 vs S2)"].push({ AppID: appId, S1_GST_Price: priceInclGST, S2_Amount: s2Amount, Difference: priceInclGST - s2Amount }); }
                        s2Map.delete(appId); // Mark as found
                    } else {
                        scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_GST_Price: priceInclGST });
                    }
                    mergedData.push(mergedS1);
                });
                
                scenarios["S2 Paid but missing in S1"] = Array.from(s2Map.values()).map(r2 => ({ AppID: String(r2[idx.appId.source2]), S2_Amount: Utils.safeParseFloat(r2[idx.s2Amount.source2]) }));
                s2Map.forEach((r2, appId) => mergedData.push({AppID: appId, Source: 'S2', S2_Amount: Utils.safeParseFloat(r2[idx.s2Amount.source2])}));

                const s1Counts = _.countBy(s1Records, r => String(r[idx.appId.source1]));
                for (const [id, count] of Object.entries(s1Counts)) { if (count > 1) scenarios['Duplicates in S1'].push({ AppID: id, Count: count }); }
                
                AppState.setState({ analysisResults: scenarios, mergedData });
                return scenarios;
            } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); console.error(error); return null; }
        },
        displayResults: (scenarios) => {
            const { selectedBPCode } = AppState.getState();
            DOM.summaryTitle.innerHTML = `Analysis Summary ${selectedBPCode !== 'all' ? `<span class="filter-badge">Filtered by: ${selectedBPCode}</span>` : ''}`;
            
            const orderedScenarios = [ "Price Exceeds Standard Rate", "S1 Records with Zero Commission", "Commission received higher than desired", "Commission received lower than desired", "Price incl GST Mismatch (S1 vs Calc)", "Price incl GST Mismatch (S1 vs S2)", "S1 Paid but missing in S2", "S2 Paid but missing in S1", "Duplicates in S1" ];
            
            DOM.statsGrid.innerHTML = `
                <div class="stat-card danger"><h3>Price Over-runs</h3><div class="stat-value">${scenarios["Price Exceeds Standard Rate"].length}</div></div>
                <div class="stat-card warning"><h3>GST Mismatches (S1)</h3><div class="stat-value">${scenarios["Price incl GST Mismatch (S1 vs Calc)"].length}</div></div>
                <div class="stat-card warning"><h3>S1 vs S2 Mismatches</h3><div class="stat-value">${scenarios["Price incl GST Mismatch (S1 vs S2)"].length}</div></div>
                <div class="stat-card info"><h3>S1 Missing in S2</h3><div class="stat-value">${scenarios["S1 Paid but missing in S2"].length}</div></div>`;

            let summaryHtml = '', detailedHtml = '';
            orderedScenarios.forEach(name => {
                const records = scenarios[name];
                if (!records) return;
                const isEmpty = records.length === 0;
                const boxClass = 'alert-box' + (isEmpty ? ' empty' : (name.includes('Mismatch') || name.includes('Exceeds') ? ' danger' : ' info'));
                const renderRow = (rec) => `<tr>${Object.values(rec).map(v => `<td>${typeof v === 'number' ? Utils.formatNumber(v) : (v || 'N/A')}</td>`).join('')}</tr>`;
                
                summaryHtml += `<div class="${boxClass}"><div class="alert-title">${name}</div><div class="alert-count">${records.length} records</div>`;
                if (!isEmpty) {
                    const headers = Object.keys(records[0]).map(h => `<th>${_.startCase(h)}</th>`).join('');
                    summaryHtml += `<table class="alert-table"><thead><tr>${headers}</tr></thead><tbody>${records.slice(0, 5).map(renderRow).join('')}</tbody></table>`;
                    if (records.length > 5) summaryHtml += `... and ${records.length - 5} more.`;
                }
                summaryHtml += `</div>`;

                if (!isEmpty) {
                    const headers = Object.keys(records[0]).map(h => `<th>${_.startCase(h)}</th>`).join('');
                    detailedHtml += `<h3 style="margin-top:2rem;">${name} (${records.length})</h3><div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${headers}</tr></thead><tbody>${records.map(renderRow).join('')}</tbody></table></div>`;
                }
            });

            DOM.results.innerHTML = summaryHtml;
            DOM.detailedResults.innerHTML = detailedHtml || '<p>No issues found in any category.</p>';
            
            const { mergedData } = AppState.getState();
            if(mergedData) {
                const headers = ['AppID', 'Source', 'BP_Code', 'BasicAmount', 'Commission', 'PriceInclGST_S1', 'S2_Amount', 'File'];
                DOM.mergedResults.innerHTML = `<div style="overflow-x:auto;"><table class="alert-table">
                    <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>${mergedData.map(rec => `<tr>${headers.map(h => `<td>${typeof rec[h] === 'number' ? Utils.formatNumber(rec[h]) : (rec[h] || '')}</td>`).join('')}</tr>`).join('')}</tbody>
                </table></div>`;
            }

            DOM.resultsSection.style.display = 'block';
            DOM.resultsSection.scrollIntoView({ behavior: 'smooth' });
        },
        exportToExcel: (isMerged) => {
            const { analysisResults, mergedData } = AppState.getState();
            const dataToExport = isMerged ? mergedData : analysisResults;
            if (!dataToExport) return Utils.showError("No data to export.");

            Utils.showLoading();
            try {
                const wb = XLSX.utils.book_new();
                if (isMerged) {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataToExport), "Merged_Data");
                } else {
                    Object.entries(dataToExport).forEach(([name, records]) => {
                        if (Array.isArray(records) && records.length > 0) {
                            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(records), name.substring(0, 31));
                        }
                    });
                }
                XLSX.writeFile(wb, `Care4Sign_Report_${isMerged ? 'Merged' : 'Detailed'}_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch (error) { Utils.showError(`Export failed: ${error.message}`); } 
            finally { Utils.hideLoading(); }
        }
    };

    const ManualComparison = {
        init: () => {
            DOM.compareManualBtn.onclick = () => {
                const s1 = new Set(DOM.manualS1Data.value.split(/[\n,]/).map(s => s.trim()).filter(Boolean));
                const s2 = new Set(DOM.manualS2Data.value.split(/[\n,]/).map(s => s.trim()).filter(Boolean));
                const onlyS1 = [...s1].filter(x => !s2.has(x));
                const onlyS2 = [...s2].filter(x => !s1.has(x));
                const common = [...s1].filter(x => s2.has(x));
                DOM.manualResultsContainer.innerHTML = [
                    { title: `Only in Source 1 (${onlyS1.length})`, data: onlyS1 },
                    { title: `Only in Source 2 (${onlyS2.length})`, data: onlyS2 },
                    { title: `Common in Both (${common.length})`, data: common }
                ].map(r => `<div class="mapping-group"><h3>${r.title}</h3><textarea readonly class="manual-compare-textarea">${r.data.join('\n')}</textarea></div>`).join('');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        FileHandler.init();
        ManualComparison.init();
        Utils.updateUserInfo();
        setInterval(Utils.updateUserInfo, 15000);
        
        DOM.analyzeBtn.onclick = () => { Utils.showLoading(); setTimeout(() => { const results = Analyzer.analyzeData(); if(results) Analyzer.displayResults(results); Utils.hideLoading(); }, 10); };
        DOM.exportDetailedBtn.onclick = () => Analyzer.exportToExcel(false);
        DOM.exportMergedBtn.onclick = () => Analyzer.exportToExcel(true);

        DOM.navItems.forEach(item => item.onclick = (e) => {
            e.preventDefault(); const contentId = item.dataset.content;
            DOM.navItems.forEach(n => n.classList.remove('active')); item.classList.add('active');
            DOM.contentSections.forEach(s => s.classList.toggle('active', s.id === contentId));
        });
        DOM.tabs.forEach(tab => tab.onclick = () => {
            const tabName = tab.dataset.tab;
            DOM.tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active');
            DOM.tabContents.forEach(c => c.classList.toggle('active', c.id.startsWith(tabName)));
        });
    });
  </script>
</body>
</html>
