<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced App ID Analyzer Pro (Care4Sign)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #059669; --secondary-dark: #047857;
      --danger: #dc2626; --warning: #f59e0b; --info: #3b82f6; --gray-50: #f9fafb; --gray-100: #f3f4f6;
      --gray-200: #e5e7eb; --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
      --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--gray-100); color: var(--gray-800); font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: var(--shadow-md); }
    .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2rem; position: relative; }
    .header h1 { margin: 0 0 0.5rem; font-size: 2.25rem; font-weight: 700; }
    .header p { opacity: 0.9; font-size: 1.1rem; }
    .user-info { position: absolute; top: 1rem; right: 2rem; background: rgba(255, 255, 255, 0.15); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
    .nav-menu { background: var(--gray-800); display: flex; padding: 0 2rem; }
    .nav-item { padding: 1rem 1.5rem; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s ease; border-bottom: 3px solid transparent; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
    .nav-item.active { background: rgba(255, 255, 255, 0.05); border-bottom-color: var(--primary); }
    .content-section { padding: 2rem; display: none; }
    .content-section.active { display: block; }
    .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--gray-800); font-weight: 600; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem; }
    .section-title .filter-badge { font-size: 0.9rem; font-weight: 500; background-color: var(--info); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; margin-left: 1rem; vertical-align: middle; }
    .upload-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .upload-box { background: var(--gray-100); border: 2px dashed var(--gray-300); border-radius: 0.75rem; padding: 1.5rem; transition: all 0.2s ease; position: relative; }
    .upload-box h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .upload-box.source2 { border-color: var(--secondary); background: rgba(5, 150, 105, 0.05); }
    .upload-box.source2::after { content: "(Paid Source)"; color: var(--secondary); font-size: 0.875rem; display: block; margin-top: 0.5rem; font-weight: 500; }
    .upload-box.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
    .file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; user-select: none; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; }
    .btn-secondary:hover { background: linear-gradient(135deg, var(--secondary-dark), var(--secondary)); transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-info { background: var(--info); color: white; }
    .btn:disabled { background: var(--gray-300); color: var(--gray-500); cursor: not-allowed; transform: none; box-shadow: none; }
    .file-info { margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(5, 150, 105, 0.1); color: var(--secondary-dark); border-radius: 0.5rem; font-size: 0.9375rem; font-weight: 500; display: none; }
    .file-info.show { display: inline-block; }
    .file-list { margin-top: 1rem; padding-left: 0; list-style-type: none; }
    .file-list li { padding: 0.5rem; border-bottom: 1px solid var(--gray-200); font-size: 0.9375rem; display: flex; justify-content: space-between; }
    .mapping-group { margin-bottom: 1rem; background: var(--gray-50); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow-sm); }
    .mapping-group h3 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--gray-700); }
    .mapping-row { display: flex; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .mapping-row.commission-row { align-items: flex-start; }
    .commission-checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem 1rem; background: white; padding: 1rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; flex-grow: 1; }
    .commission-checkbox-group label { display: flex; align-items: center; font-weight: normal; min-width: auto; }
    .commission-checkbox-group input { margin-right: 0.5rem; }
    .mapping-row label { min-width: 180px; font-weight: 500; color: var(--gray-700); }
    select, input[type="number"], input[type="text"] { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; font-size: 0.9375rem; min-width: 220px; background: white; }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    .options-section { margin-bottom: 2rem; }
    .option-group { margin-bottom: 1.5rem; background: var(--gray-50); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow-sm); }
    .checkbox-group { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .checkbox-group input { margin-right: 0.75rem; }
    .checkbox-group label { font-weight: 500; color: var(--gray-700); }
    .gst-options { margin-top: 1rem; background: rgba(14, 165, 233, 0.05); border-left: 4px solid var(--info); padding: 1rem; border-radius: 0.5rem; }
    .gst-options h4 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.1rem; color: var(--gray-700); }
    .commission-input { margin-top: 1rem; background: rgba(5, 150, 105, 0.05); border-left: 4px solid var(--secondary); padding: 1rem; border-radius: 0.5rem; }
    .commission-input h4 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.1rem; color: var(--gray-700); }
    .commission-input input { width: 100px; margin-right: 0.5rem; }
    .analyze-btn { width: 100%; padding: 1rem; margin: 2rem 0; font-size: 1.1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow); border-top: 4px solid var(--primary); }
    .stat-card.warning { border-top-color: var(--warning); } .stat-card.danger { border-top-color: var(--danger); }
    .stat-card.success { border-top-color: var(--secondary); } .stat-card.info { border-top-color: var(--info); }
    .stat-card h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; color: var(--gray-600); }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem; }
    .stat-subtext { font-size: 0.875rem; color: var(--gray-500); }
    .alert-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .alert-box { background: white; border-left: 5px solid var(--warning); border-radius: 0.75rem; box-shadow: var(--shadow); padding: 1.5rem; height: 100%; }
    .alert-box.empty { background: var(--gray-50); border-left-color: var(--gray-400); } .alert-box.danger { border-left-color: var(--danger); }
    .alert-box.success { border-left-color: var(--secondary); } .alert-box.info { border-left-color: var(--info); }
    .alert-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--warning); }
    .alert-box.empty .alert-title { color: var(--gray-500); } .alert-box.danger .alert-title { color: var(--danger); }
    .alert-box.success .alert-title { color: var(--secondary); } .alert-box.info .alert-title { color: var(--info); }
    .alert-count { font-size: 1.25rem; font-weight: 800; color: var(--warning-dark); margin-bottom: 1rem; }
    .alert-table { width: 100%; border-collapse: collapse; font-size: 0.9375rem; margin-top: 1rem; }
    .alert-table th, .alert-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .alert-table th { background: var(--gray-50); color: var(--gray-700); font-weight: 600; }
    .amount-cell { text-align: right; font-family: 'Roboto Mono', monospace; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
    .loading-overlay.show { visibility: visible; opacity: 1; }
    .spinner { width: 3rem; height: 3rem; border: 4px solid rgba(99, 102, 241, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .error-message { margin: 1rem 0; padding: 1rem; background: rgba(220, 38, 38, 0.1); color: var(--danger); border-radius: 0.5rem; display: none; border-left: 4px solid var(--danger); }
    .error-message.show { display: block; }
    .export-btn { margin-top: 1rem; }
    .manual-compare-textarea { width: 100%; min-height: 200px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; font-family: 'Roboto Mono', monospace; font-size: 0.875rem; }
    .tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray-600); transition: all 0.2s ease; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background-color: rgba(99, 102, 241, 0.05); }
    .tab:hover:not(.active) { color: var(--primary-dark); background-color: rgba(99, 102, 241, 0.05); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .upload-section, .alert-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info"></div>
      <h1>🔍 Advanced App ID Analyzer Pro (Care4Sign)</h1>
      <p>Comprehensive Payment Reconciliation & Analysis Tool</p>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" data-content="main-analysis">Main Analysis</a>
      <a href="#" class="nav-item" data-content="manual-comparison">Manual Comparison</a>
    </nav>

    <!-- Main Analysis Section -->
    <div id="main-analysis" class="content-section active">
      <h2 class="section-title">1. Data Sources</h2>
      <div class="upload-section">
        <div class="upload-box" id="drop1">
          <h3>Source 1 Files (Your Report)</h3>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
          <button class="btn btn-primary" id="upload-btn-1">Choose Files</button>
          <div id="file-info-1" class="file-info"></div>
          <ul id="file-list-1" class="file-list"></ul>
        </div>
        <div class="upload-box source2" id="drop2">
          <h3>Source 2 File (Paid Source)</h3>
          <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
          <button class="btn btn-secondary" id="upload-btn-2">Choose File</button>
          <div id="file-info-2" class="file-info"></div>
        </div>
      </div>
      
      <div id="bp-code-filter-container" class="mapping-group" style="display: none;">
        <h3>Filter by BP Code (Source 1)</h3>
        <div id="bp-code-filter"></div>
      </div>

      <h2 class="section-title">2. Column Mappings</h2>
      <div id="column-mappings" class="mapping-group"></div>
      
      <h2 class="section-title">3. Analysis Options</h2>
      <div class="options-section">
        <div class="option-group">
           <div class="checkbox-group">
            <input type="checkbox" id="include-commission">
            <label for="include-commission">Enable Desired Commission % Analysis</label>
          </div>
          <div class="commission-input" id="commission-input" style="display: none;">
            <h4>Commission Analysis</h4>
            <label> Desired Commission Percentage: <input type="number" id="desired-commission" min="0" max="100" step="0.01" value="5.00"> % </label>
          </div>
          <div class="gst-options">
            <h4>GST Options (S1 Only)</h4>
            <label><input type="checkbox" id="apply-gst"> Apply 18% GST to S1 Basic Amount for comparison</label>
            <label><input type="checkbox" id="gst-round" disabled> Round GST amounts</label>
          </div>
        </div>
      </div>

      <div id="error-message" class="error-message"></div>
      <button id="analyze-btn" class="btn btn-secondary analyze-btn" disabled>Analyze Data</button>

      <div id="results-section" style="display: none;">
        <div class="tabs">
          <div class="tab active" data-tab="summary">Summary View</div>
          <div class="tab" data-tab="detailed">Detailed Results</div>
          <div class="tab" data-tab="merged">Merged Data</div>
        </div>

        <div id="summary-view" class="tab-content active">
          <h2 class="section-title" id="summary-title">Analysis Summary</h2>
          <div class="stats-grid" id="stats-grid"></div>
          <div id="results" class="alert-container"></div>
        </div>

        <div id="detailed-view" class="tab-content">
          <h2 class="section-title">Detailed Results</h2>
          <div id="detailed-results"></div>
          <button id="export-detailed-btn" class="btn btn-primary export-btn">Export Detailed Report</button>
        </div>
        
        <div id="merged-view" class="tab-content">
          <h2 class="section-title">Merged Data View</h2>
          <div id="merged-results"></div>
          <button id="export-merged-btn" class="btn btn-secondary export-btn">Export Merged Data</button>
        </div>
      </div>
    </div>

    <!-- Manual Comparison Section -->
    <div id="manual-comparison" class="content-section">
        <h2 class="section-title">Manual App ID Comparison</h2>
        <div class="manual-compare-grid">
            <div class="manual-compare-box">
                <h3>Source 1 App IDs</h3>
                <textarea id="manual-s1-data" class="manual-compare-textarea" placeholder="Paste App IDs here..."></textarea>
            </div>
            <div class="manual-compare-box">
                <h3>Source 2 App IDs</h3>
                <textarea id="manual-s2-data" class="manual-compare-textarea" placeholder="Paste App IDs here..."></textarea>
            </div>
        </div>
        <button id="compare-manual-btn" class="btn btn-primary analyze-btn">Compare App IDs</button>
        <div id="manual-results-container"></div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay"> <div class="spinner"></div> </div>

  <script>
    const AppState = (() => {
      let state = {
        source1Files: [], source2Files: [],
        columnMappings: { commission: { source1: [] } },
        selectedBPCode: 'all', analysisResults: null, mergedData: null,
        analysisOptions: { applyGST: false, gstRound: false, includeCommission: false, desiredCommission: 5.0 }
      };
      const validateState = () => {
        const { source1Files, source2Files, columnMappings } = state;
        if (source1Files.length === 0 || source2Files.length === 0) return false;
        const s1 = ['appId', 'amount', 'date', 'bpCode', 'product', 'priceInclGst'];
        const s2 = ['appId', 's2Amount'];
        const s1Valid = s1.every(id => columnMappings[id]?.source1);
        const s2Valid = s2.every(id => columnMappings[id]?.source2);
        const commissionValid = columnMappings.commission?.source1?.length > 0;
        return s1Valid && s2Valid && commissionValid;
      };
      return {
        getState: () => ({ ...state }),
        setState: (newState) => { state = { ...state, ...newState }; return validateState(); },
        resetAnalysis: () => { state.analysisResults = null; state.mergedData = null; },
        isValid: validateState
      };
    })();

    const DOM = {
      // Main Elements
      userInfo: document.getElementById('user-info'),
      fileInput1: document.getElementById('file-input-1'),
      fileInput2: document.getElementById('file-input-2'),
      uploadBtn1: document.getElementById('upload-btn-1'),
      uploadBtn2: document.getElementById('upload-btn-2'),
      drop1: document.getElementById('drop1'),
      drop2: document.getElementById('drop2'),
      fileInfo1: document.getElementById('file-info-1'),
      fileInfo2: document.getElementById('file-info-2'),
      fileList1: document.getElementById('file-list-1'),
      bpCodeFilterContainer: document.getElementById('bp-code-filter-container'),
      bpCodeFilter: document.getElementById('bp-code-filter'),
      columnMappings: document.getElementById('column-mappings'),
      analyzeBtn: document.getElementById('analyze-btn'),
      errorMessage: document.getElementById('error-message'),
      resultsSection: document.getElementById('results-section'),
      statsGrid: document.getElementById('stats-grid'),
      results: document.getElementById('results'),
      summaryTitle: document.getElementById('summary-title'),
      detailedResults: document.getElementById('detailed-results'),
      exportDetailedBtn: document.getElementById('export-detailed-btn'),
      mergedResults: document.getElementById('merged-results'),
      exportMergedBtn: document.getElementById('export-merged-btn'),
      loadingOverlay: document.getElementById('loading-overlay'),
      
      // Options
      includeCommission: document.getElementById('include-commission'),
      commissionInput: document.getElementById('commission-input'),
      desiredCommission: document.getElementById('desired-commission'),
      applyGST: document.getElementById('apply-gst'),
      gstRound: document.getElementById('gst-round'),

      // Navigation & Manual
      navItems: document.querySelectorAll('.nav-item'),
      contentSections: document.querySelectorAll('.content-section'),
      tabs: document.querySelectorAll('.tab'),
      manualS1Data: document.getElementById('manual-s1-data'),
      manualS2Data: document.getElementById('manual-s2-data'),
      compareManualBtn: document.getElementById('compare-manual-btn'),
      manualResultsContainer: document.getElementById('manual-results-container'),
    };

    const UIManager = {
      resetAnalysisUI: () => {
        DOM.resultsSection.style.display = 'none';
        AppState.resetAnalysis();
        DOM.summaryTitle.innerHTML = 'Analysis Summary';
        Analyzer.updateAnalyzeBtn();
      }
    };

    const Utils = {
      showLoading: () => DOM.loadingOverlay.classList.add('show'),
      hideLoading: () => DOM.loadingOverlay.classList.remove('show'),
      showError: (msg) => { console.error("Error:", msg); DOM.errorMessage.textContent = msg; DOM.errorMessage.style.display = 'block'; setTimeout(() => DOM.errorMessage.style.display = 'none', 8000); },
      updateUserInfo: () => { const now = new Date().toISOString().replace('T', ' ').slice(0, 19); DOM.userInfo.textContent = `User: ksismad | UTC ${now}`; },
      formatNumber: (num) => (typeof num !== 'number' || isNaN(num)) ? num : parseFloat(num.toFixed(2)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
      findMatch: (headers, patterns) => {
        for (let pattern of patterns) {
          const index = headers.findIndex(h => h && pattern.test(String(h)));
          if (index !== -1) return index;
        }
        return '';
      },
      safeParseFloat: (value) => {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          const cleaned = value.replace(/[^0-9.-]/g, '');
          return parseFloat(cleaned) || 0;
        }
        return 0;
      },
    };

    const FileHandler = {
      init: () => {
        DOM.uploadBtn1.onclick = e => { e.preventDefault(); DOM.fileInput1.click(); };
        DOM.uploadBtn2.onclick = e => { e.preventDefault(); DOM.fileInput2.click(); };
        DOM.fileInput1.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 1); };
        DOM.fileInput2.onchange = e => { if (e.target.files.length) FileHandler.handleFileSelection(e.target.files, 2); };
        [{ drop: DOM.drop1, src: 1 }, { drop: DOM.drop2, src: 2 }].forEach(o => {
          o.drop.ondragover = e => { e.preventDefault(); o.drop.classList.add('dragover'); };
          o.drop.ondragleave = () => o.drop.classList.remove('dragover');
          o.drop.ondrop = e => { e.preventDefault(); o.drop.classList.remove('dragover'); if (e.dataTransfer.files.length) FileHandler.handleFileSelection(e.dataTransfer.files, o.src); };
        });
      },
      handleFileSelection: async (files, src) => {
        UIManager.resetAnalysisUI();
        Utils.showLoading();
        try {
          const fileArray = Array.from(files);
          const targetState = src === 1 ? 'source1Files' : 'source2Files';
          const fileInfoDOM = src === 1 ? DOM.fileInfo1 : DOM.fileInfo2;
          
          const results = await Promise.all(fileArray.map(file => FileHandler.processExcelFile(file).catch(err => ({ error: err }))));
          const successfulFiles = results.filter(r => !r.error);
          
          if (successfulFiles.length > 0) {
            AppState.setState({ [targetState]: successfulFiles });
            if (src === 1) {
                DOM.fileList1.innerHTML = successfulFiles.map(f => `<li><span>${f.fileName}</span><span>${f.records.length} rows</span></li>`).join('');
            }
            fileInfoDOM.textContent = `${successfulFiles.length} file(s) loaded (${successfulFiles.reduce((acc, f) => acc + f.records.length, 0)} total rows)`;
            fileInfoDOM.classList.add('show');
          }
          ColumnMapper.setup();
        } catch (error) { Utils.showError(`File handling error: ${error.message}`);
        } finally { Utils.hideLoading(); }
      },
      processExcelFile: (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!data || data.length < 2) return reject(new Error('File has no data.'));
            resolve({ headers: data[0].map(h => String(h).trim()), records: data.slice(1), fileName: file.name });
          } catch (err) { reject(new Error(`Parsing error: ${err.message}`)); }
        };
        reader.onerror = () => reject(new Error('Could not read file.'));
        reader.readAsArrayBuffer(file);
      }),
    };

    const ColumnMapper = {
      setup: () => {
        const { source1Files, source2Files } = AppState.getState();
        const s1Headers = source1Files[0]?.headers || [];
        const s2Headers = source2Files[0]?.headers || [];
        
        if (s1Headers.length === 0 || s2Headers.length === 0) {
          DOM.columnMappings.innerHTML = '<p>Please load files for both sources.</p>';
          return;
        }
        
        const columns = [
          { id: 'appId', label: 'App ID (Application...)', p: [/app.*id/i, /applicati/i], s1: true, s2: true },
          { id: 'amount', label: 'Basic Amount (S1)', p: [/basic/i], s1: true },
          { id: 's2Amount', label: 'Final Price (S2)', p: [/price i/i, /amount/i], s2: true },
          { id: 'bpCode', label: 'BP Code (S1)', p: [/bp.*code/i], s1: true },
          { id: 'product', label: 'Product Desc (S1)', p: [/product/i], s1: true },
          { id: 'priceInclGst', label: 'Price incl of GST (S1)', p: [/price i/i], s1: true },
          { id: 'date', label: 'Date (S1)', p: [/date/i, /added ti/i], s1: true },
          { id: 'commission', label: 'Commission Columns (S1)', p: [/platin/i, /bp co/i, /bp wis/i], s1: true, type: 'checkbox' },
        ];
        
        let html = '';
        columns.forEach(col => {
          html += `<div class="mapping-row ${col.type === 'checkbox' ? 'commission-row' : ''}"><label>${col.label} *:</label>`;
          if (col.type === 'checkbox') {
            html += `<div class="commission-checkbox-group">${s1Headers.map((h, i) => {
                const isMatch = col.p.some(p => p.test(h));
                return `<label><input type="checkbox" class="commission-checkbox" value="${i}" ${isMatch ? 'checked' : ''}>${h || `Col ${i+1}`}</label>`;
            }).join('')}</div>`;
          } else {
            if (col.s1) html += `<select data-col="${col.id}" data-src="1"><option value="">Select S1 Column</option>${s1Headers.map((h, i) => `<option value="${i}" ${Utils.findMatch([h], col.p) === 0 ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
            if (col.s2) html += `<select data-col="${col.id}" data-src="2"><option value="">Select S2 Column</option>${s2Headers.map((h, i) => `<option value="${i}" ${Utils.findMatch([h], col.p) === 0 ? 'selected' : ''}>${h || `Col ${i+1}`}</option>`).join('')}</select>`;
          }
          html += '</div>';
        });
        
        DOM.columnMappings.innerHTML = html;
        document.querySelectorAll('select, .commission-checkbox').forEach(el => el.addEventListener('change', ColumnMapper.update));
        ColumnMapper.update();
        ColumnMapper.populateBPCodeFilter();
      },
      update: () => {
        const mappings = { commission: { source1: [] } };
        document.querySelectorAll('select[data-col]').forEach(sel => {
            const id = sel.dataset.col;
            const src = sel.dataset.src === '1' ? 'source1' : 'source2';
            if (!mappings[id]) mappings[id] = {};
            mappings[id][src] = sel.value;
        });
        mappings.commission.source1 = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);
        AppState.setState({ columnMappings: mappings });
        UIManager.resetAnalysisUI();
      },
      populateBPCodeFilter: () => {
        const { source1Files, columnMappings } = AppState.getState();
        const bpCodeIndex = columnMappings.bpCode?.source1;
        if (!source1Files.length || !bpCodeIndex) return (DOM.bpCodeFilterContainer.style.display = 'none');
        
        const allRecords = source1Files.flatMap(f => f.records);
        const uniqueBPCodes = [...new Set(allRecords.map(r => r[bpCodeIndex]).filter(Boolean))].sort();
        if (uniqueBPCodes.length === 0) return (DOM.bpCodeFilterContainer.style.display = 'none');

        DOM.bpCodeFilter.innerHTML = `<select id="bp-code-select" style="width: 100%;"><option value="all">All BP Codes</option>${uniqueBPCodes.map(code => `<option value="${code}">${code}</option>`).join('')}</select>`;
        DOM.bpCodeFilterContainer.style.display = 'block';
        document.getElementById('bp-code-select').onchange = (e) => {
            AppState.setState({ selectedBPCode: e.target.value });
            UIManager.resetAnalysisUI();
        };
      }
    };

    const Analyzer = {
      analyze: () => {
        Utils.showLoading();
        setTimeout(() => {
          try {
            const results = Analyzer._performAnalysis();
            if (results) Analyzer.display(results);
          } catch (error) { Utils.showError(`Analysis failed: ${error.message}`); console.error(error);
          } finally { Utils.hideLoading(); }
        }, 10);
      },
      _performAnalysis: () => {
        const { source1Files, source2Files, columnMappings: idx, selectedBPCode, analysisOptions } = AppState.getState();
        
        const standardRates = {
            'CLASS_3_SIGNING_2_YEAR': 840, 'CLASS_3_ENCRYPTION_2_YEAR': 840, 'CLASS_3_SIGNING/ENCRYPTION_2_YEAR': 1680,
            'CLASS_3_SIGNING_3_YEAR': 1260, 'CLASS_3_ENCRYPTION_3_YEAR': 1260, 'CLASS_3_SIGNING/ENCRYPTION_3_YEAR': 2520,
            'CLASS_3_SIGNING_1_YEAR': 750, 'CLASS_3_ENCRYPTION_1_YEAR': 750, 'CLASS_3_SIGNING/ENCRYPTION_1_YEAR': 1500
        };
        const normalizeKey = (str) => (str || '').toUpperCase().replace(/\s+/g, ' ').trim();

        let s1Records = source1Files.flatMap(f => f.records.map(r => ({...r, fileName: f.fileName})));
        if (selectedBPCode !== 'all') {
            s1Records = s1Records.filter(r => String(r[idx.bpCode.source1]) === selectedBPCode);
        }

        const s2Map = new Map(source2Files[0].records.map(r => [String(r[idx.appId.source2]), r]));
        const s1Map = new Map();
        s1Records.forEach(r => { const appId = String(r[idx.appId.source1]); if (!s1Map.has(appId)) s1Map.set(appId, []); s1Map.get(appId).push(r); });

        const scenarios = {
            "S1 Paid but missing in S2": [], "S2 Paid but missing in S1": [], "S2 Paid, S1 Paid but amount different": [],
            "Commission received higher than desired": [], "Commission received lower than desired": [], "Duplicates in S1": [], "Duplicates in S2": [],
            "S1 Marked Paid but Commission Missing": [], "Price Exceeds Standard Rate": [], "S1 GST Calculation Mismatch": [], "S1 vs S2 Price Mismatch": []
        };
        let mergedData = [];

        s1Map.forEach((s1Entries, appId) => {
            s1Entries.forEach(r1 => {
                const commission = idx.commission.source1.reduce((sum, i) => sum + Utils.safeParseFloat(r1[i]), 0);
                const basicAmount = Utils.safeParseFloat(r1[idx.amount.source1]);
                const s1GstPrice = Utils.safeParseFloat(r1[idx.priceInclGst.source1]);
                const r2 = s2Map.get(appId);
                const s2Amount = r2 ? Utils.safeParseFloat(r2[idx.s2Amount.source2]) : null;

                // --- Perform all checks ---
                if (commission === 0) scenarios["S1 Marked Paid but Commission Missing"].push({ AppID: appId });
                
                if (analysisOptions.includeCommission) {
                    const desired = basicAmount * (analysisOptions.desiredCommission / 100);
                    const diff = commission - desired;
                    if (diff > 0.01) scenarios["Commission received higher than desired"].push({ AppID: appId, Received: commission, Desired: desired, Diff: diff });
                    if (diff < -0.01) scenarios["Commission received lower than desired"].push({ AppID: appId, Received: commission, Desired: desired, Diff: diff });
                }

                const productKey = normalizeKey(r1[idx.product.source1]);
                if (standardRates[productKey] && basicAmount > standardRates[productKey]) {
                    scenarios["Price Exceeds Standard Rate"].push({ AppID: appId, Product: productKey, Charged: basicAmount, Standard: standardRates[productKey], Diff: basicAmount - standardRates[productKey] });
                }
                
                let expectedGstPrice = basicAmount * 1.18;
                if (analysisOptions.applyGST && analysisOptions.gstRound) expectedGstPrice = Math.round(expectedGstPrice);
                if (Math.abs(s1GstPrice - expectedGstPrice) > 0.01) {
                    scenarios["S1 GST Calculation Mismatch"].push({ AppID: appId, Basic: basicAmount, StatedGSTPrice: s1GstPrice, CalcGSTPrice: expectedGstPrice, Diff: s1GstPrice - expectedGstPrice });
                }
                
                if (r2) {
                    if (Math.abs(basicAmount - s2Amount) > 0.01) scenarios["S2 Paid, S1 Paid but amount different"].push({ AppID: appId, S1_Basic: basicAmount, S2_Price: s2Amount, Diff: s2Amount - basicAmount });
                    if (Math.abs(s1GstPrice - s2Amount) > 0.01) scenarios["S1 vs S2 Price Mismatch"].push({ AppID: appId, S1_GST_Price: s1GstPrice, S2_Price: s2Amount, Diff: s2Amount - s1GstPrice });
                } else {
                    scenarios["S1 Paid but missing in S2"].push({ AppID: appId, S1_Basic: basicAmount, S1_GST_Price: s1GstPrice });
                }
                
                mergedData.push({ AppID: appId, Source: 'S1', Status: 'Paid', Basic_Amount: basicAmount, GST_Price: s1GstPrice, Commission: commission, BP_Code: r1[idx.bpCode.source1], File: r1.fileName });
            });
        });

        s2Map.forEach((r2, appId) => {
            if (!s1Map.has(appId)) {
                const s2Amount = Utils.safeParseFloat(r2[idx.s2Amount.source2]);
                scenarios["S2 Paid but missing in S1"].push({ AppID: appId, S2_Price: s2Amount });
                mergedData.push({ AppID: appId, Source: 'S2', Status: 'Paid', Basic_Amount: null, GST_Price: s2Amount, Commission: null, BP_Code: null, File: source2Files[0].fileName });
            }
        });
        
        Object.entries(_.countBy(s1Records, r => r[idx.appId.source1])).filter(([, c]) => c > 1).forEach(([appId, c]) => scenarios["Duplicates in S1"].push({ AppID: appId, Count: c }));
        Object.entries(_.countBy(source2Files[0].records, r => r[idx.appId.source2])).filter(([, c]) => c > 1).forEach(([appId, c]) => scenarios["Duplicates in S2"].push({ AppID: appId, Count: c }));
        
        return { scenarios, mergedData };
      },
      display: ({ scenarios, mergedData }) => {
        const { selectedBPCode } = AppState.getState();
        DOM.summaryTitle.innerHTML = `Analysis Summary <span class="filter-badge">${selectedBPCode === 'all' ? 'All BP Codes' : `Filtered by: ${selectedBPCode}`}</span>`;
        
        const orderedScenarios = [
            "Price Exceeds Standard Rate", "S1 GST Calculation Mismatch", "S1 vs S2 Price Mismatch",
            "S1 Paid but missing in S2", "S2 Paid but missing in S1", "S2 Paid, S1 Paid but amount different",
            "Commission received higher than desired", "Commission received lower than desired",
            "S1 Marked Paid but Commission Missing", "Duplicates in S1", "Duplicates in S2"
        ];

        let summaryHtml = '', detailedHtml = '';
        orderedScenarios.forEach(name => {
            const records = scenarios[name] || [];
            if (!records) return;
            const isEmpty = records.length === 0;
            const boxClass = 'alert-box' + (isEmpty ? ' empty' : (name.includes('Missing') || name.includes('Exceeds') || name.includes('Mismatch') ? ' danger' : ' warning'));
            
            const renderTable = (recs) => {
                if(recs.length === 0) return '';
                const headers = Object.keys(recs[0]);
                let table = `<table class="alert-table"><thead><tr>${headers.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>`;
                table += recs.map(rec => `<tr>${headers.map(h => `<td class="${typeof rec[h] === 'number' ? 'amount-cell' : ''}">${Utils.formatNumber(rec[h])}</td>`).join('')}</tr>`).join('');
                table += '</tbody></table>';
                return table;
            };
            
            summaryHtml += `<div class="${boxClass}"><div class="alert-title">${name}</div><div class="alert-count">${records.length} records</div>`;
            if (!isEmpty) {
                summaryHtml += renderTable(records.slice(0, 5));
                if (records.length > 5) summaryHtml += `<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);">+ ${records.length - 5} more</div>`;
            } else { summaryHtml += `<p style="color:var(--gray-500);font-style:italic;">No records found</p>`; }
            summaryHtml += `</div>`;

            if(!isEmpty) {
                detailedHtml += `<h3 style="margin-top:2rem;">${name} (${records.length})</h3><div style="overflow-x:auto;">${renderTable(records)}</div>`;
            }
        });
        
        DOM.statsGrid.innerHTML = `<div class="stat-card danger"><h3>Total Alerts</h3><div class="stat-value">${orderedScenarios.reduce((sum, s) => sum + (scenarios[s]?.length || 0), 0)}</div></div>`;
        DOM.results.innerHTML = summaryHtml;
        DOM.detailedResults.innerHTML = detailedHtml || '<p>No issues found in detailed analysis.</p>';
        
        // Merged Data
        const mergedHeaders = Object.keys(mergedData[0] || {});
        DOM.mergedResults.innerHTML = `<div style="overflow-x:auto;"><table class="alert-table"><thead><tr>${mergedHeaders.map(h => `<th>${_.startCase(h)}</th>`).join('')}</tr></thead><tbody>
            ${mergedData.slice(0, 200).map(rec => `<tr>${mergedHeaders.map(h => `<td class="${typeof rec[h] === 'number' ? 'amount-cell' : ''}">${Utils.formatNumber(rec[h])}</td>`).join('')}</tr>`).join('')}
        </tbody></table>${mergedData.length > 200 ? `<p>+ ${mergedData.length - 200} more...</p>` : ''}</div>`;

        DOM.resultsSection.style.display = 'block';
      },
      exportReport: (isMerged) => {
        const { scenarios, mergedData } = Analyzer._performAnalysis();
        const dataToExport = isMerged ? [{ name: "Merged_Data", records: mergedData }]
                                      : Object.entries(scenarios).map(([name, records]) => ({ name, records })).filter(s => s.records.length > 0);
        
        if (dataToExport.length === 0) return Utils.showError("No data to export.");
        Utils.showLoading();
        try {
          const wb = XLSX.utils.book_new();
          dataToExport.forEach(sheet => {
            const ws = XLSX.utils.json_to_sheet(sheet.records);
            XLSX.utils.book_append_sheet(wb, ws, sheet.name.substring(0, 31));
          });
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          XLSX.writeFile(wb, `Report_${isMerged ? 'Merged' : 'Detailed'}_${timestamp}.xlsx`);
        } catch (e) { Utils.showError(`Export failed: ${e.message}`); }
        finally { Utils.hideLoading(); }
      }
    };
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      Utils.updateUserInfo(); setInterval(Utils.updateUserInfo, 15000);
      FileHandler.init();
      DOM.analyzeBtn.onclick = Analyzer.analyze;
      DOM.exportDetailedBtn.onclick = () => Analyzer.exportReport(false);
      DOM.exportMergedBtn.onclick = () => Analyzer.exportReport(true);

      // Options listeners
      [DOM.includeCommission, DOM.applyGST, DOM.gstRound, DOM.desiredCommission].forEach(el => {
        el.onchange = () => {
            AppState.setState({ analysisOptions: {
                includeCommission: DOM.includeCommission.checked,
                applyGST: DOM.applyGST.checked,
                gstRound: DOM.gstRound.checked,
                desiredCommission: Utils.safeParseFloat(DOM.desiredCommission.value)
            }});
            DOM.commissionInput.style.display = DOM.includeCommission.checked ? 'block' : 'none';
            DOM.gstRound.disabled = !DOM.applyGST.checked;
            if(!DOM.applyGST.checked) DOM.gstRound.checked = false;
        };
      });

      // Nav and Tab listeners
      DOM.navItems.forEach(item => item.onclick = (e) => {
        e.preventDefault();
        DOM.navItems.forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        DOM.contentSections.forEach(s => s.classList.toggle('active', s.id === item.dataset.content));
      });
      DOM.tabs.forEach(tab => tab.onclick = () => {
        const parent = tab.closest('.content-section');
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        parent.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id.startsWith(tab.dataset.tab)));
      });
    });
  </script>
</body>
</html>
